{% extends 'base.html' %}
{% from 'macros/components.html' import button, alert %}
{% block title %}Upload Diagram{% endblock %}

{% block hero_title %}Upload&nbsp;a&nbsp;Diagram{% endblock %}
{% block hero_subtitle %}Drag &amp; drop or browse for a file (<code>.wr</code>, <code>.json</code>, <code>.png</code>) to add it to Rules&nbsp;Central.{% endblock %}
{% block content %}
<section class="u-section py-12">

  <div class="card--glass glassmorphism p-8 rounded-2xl">
  <!-- Upload form -->
  <form id="upload-form"
        action="{{ url_for('routes.upload_file') }}"
        method="post"
        enctype="multipart/form-data"
        class="space-y-8"
        x-data="uploadForm()"
        @submit.prevent="submitForm">

    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- Drag & Drop Zone -->
    <div class="transition-all duration-300 rounded-2xl border-2 border-dashed flex justify-center items-center"
         :class="hover ? 'border-primary-500 bg-primary-500/10' : 'border-slate-600/60 bg-slate-800/20'"
         @dragover.prevent="hover = true"
         @dragleave.prevent="hover = false"
         @drop.prevent="handleDrop($event)">
      <div class="p-12 text-center">
        <!-- Icon -->
        <div class="mx-auto mb-4 h-14 w-14 text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M3 15a4 4 0 00.88 7.903L4 23h16a4 4 0 00.88-7.903A5 5 0 0015 9h-1a5 5 0 000-10 5 5 0 00-4.9 4H9a5 5 0 00-4.12 8.06A4 4 0 003 15zm12 2l-3-3m0 0l-3 3m3-3v12" />
          </svg>
        </div>

        <!-- Prompt -->
        <p class="text-sm text-slate-400" x-show="!file">
          <span class="font-semibold text-primary-400 cursor-pointer" @click="$refs.fileInput.click()">
            Click&nbsp;to&nbsp;browse
          </span>
          or drag &amp; drop
        </p>

        <!-- Selected file -->
        <p class="text-sm text-slate-300" x-show="file">
          <span class="font-medium text-primary-300" x-text="file.name"></span> selected
        </p>

        <!-- Hidden file input -->
        <input type="file"
               name="file"
               x-ref="fileInput"
               class="sr-only"
               @change="file = $refs.fileInput.files[0]">
      </div>
    </div>

    <!-- Error -->
    {% if error %}
      {{ alert(error, 'error') }}
    {% endif %}

    <!-- Actions -->
    <div class="flex flex-col sm:flex-row items-center gap-4">
      <div class="w-full sm:w-auto">
        {{ button('Upload Diagram', 'primary', 'submit') }}
      </div>

      <template x-if="isLoading">
        <span class="text-sm text-slate-400">Uploadingâ€¦ <span x-text="progress + '%'"></span></span>
      </template>
    </div>

    <!-- Progress bar -->
    <div class="h-2 rounded-full bg-slate-700/50 overflow-hidden transition-opacity duration-300"
         :class="isLoading ? 'opacity-100' : 'opacity-0'">
      <div class="h-full bg-primary-500"
           :style="`width: ${progress}%`"></div>
    </div>
  </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('uploadForm', () => ({
    hover: false,
    file: null,
    isLoading: false,
    progress: 0,

    handleDrop(ev) {
      this.hover = false;
      if (ev.dataTransfer.files.length) {
        this.file = ev.dataTransfer.files[0];
      }
    },

    submitForm() {
      if (!this.file || this.isLoading) return;

      this.isLoading = true;
      this.progress = 0;

      const formData = new FormData(this.$root);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', this.$root.action);

      xhr.upload.onprogress = (ev) => {
        if (ev.lengthComputable) {
          this.progress = Math.round((ev.loaded / ev.total) * 100);
        }
      };

      xhr.onload = () => {
        this.isLoading = false;
        if (xhr.status >= 200 && xhr.status < 300) {
          window.location.href = '{{ url_for("routes.index") }}';
        } else {
          console.error('Upload failed');
        }
      };

      xhr.onerror = () => {
        this.isLoading = false;
        console.error('Upload error');
      };

      xhr.send(formData);
    }
  }));
});
</script>
{% endblock %}