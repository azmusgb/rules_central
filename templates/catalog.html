{% extends "base.html" %}

{% block title %}Catalog | Rules Central{% endblock title %}
{% block description %}Browse, search, and filter all diagrams and rule visualizations in Rules Central.{% endblock description %}

{% block content %}

{# ------------------------------------------------------------------
   HERO
------------------------------------------------------------------ #}
<header class="wrapper rc-container pt-24 pb-8 text-center space-y-4 rc-catalog-hero">
  <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight leading-tight bg-gradient-to-br from-primary-500 to-primary-700 dark:from-primary-300 dark:to-primary-500 bg-clip-text text-transparent">
    Catalog
  </h1>
  <p class="text-base md:text-lg text-slate-600 dark:text-slate-300 max-w-xl mx-auto leading-relaxed">
    Browse diagrams with quick search, type filters, favorites, and sort options.
  </p>
</header>


{# ------------------------------------------------------------------
   SEARCH + FILTER BAR
   Variables expected from view (all optional / safe defaulting):
     q               -> current search string
     selected_types  -> list[str]
     favorites_only  -> bool
     updated_recent  -> bool  (last 7 days)
     type_options    -> list[str] of known diagram types
------------------------------------------------------------------ #}
{% set q              = request.args.get('q','') %}
{% set selected_types = request.args.getlist('type') %}
{% set favorites_only = request.args.get('fav') in ('1','true','True') %}
{% set updated_recent = request.args.get('recent') in ('1','true','True') %}

<section class="wrapper rc-container rc-section rc-catalog-searchwrap">
  <form action="{{ url_for('main.catalog') }}" method="get" role="search" class="rc-catalog-search rc-card rc-surface-1">
    <label for="rc-cat-search" class="sr-only">Search diagrams</label>
    <input id="rc-cat-search"
           type="search"
           name="q"
           value="{{ q }}"
           placeholder="Search diagrams…"
           autocomplete="off"
           spellcheck="false"
           class="rc-cat-search-input"
           aria-label="Search diagrams">

    {# Filters Drawer Trigger (mobile) #}
    <button type="button" id="rc-cat-filter-open" class="rc-cat-filter-open sm:hidden" aria-label="Open filters">
      Filters
    </button>

    {# Inline filters (desktop) #}
    <fieldset class="rc-cat-filters hidden sm:flex" aria-label="Filters">
      <legend class="sr-only">Filters</legend>

      <div class="rc-cat-filtergroup">
        <span class="rc-cat-filterlabel">Type:</span>
        {% set type_options = type_options if type_options is defined else ['Flowchart','Sequence','Class','State'] %}
        {% for t in type_options %}
          <label class="rc-cat-filterchk">
            <input type="checkbox" name="type" value="{{ t }}" {% if t in selected_types %}checked{% endif %}>
            {{ t }}
          </label>
        {% endfor %}
      </div>

      <div class="rc-cat-filtergroup">
        <label class="rc-cat-filterchk">
          <input type="checkbox" name="fav" value="1" {% if favorites_only %}checked{% endif %}>
          Favorites only
        </label>
        <label class="rc-cat-filterchk">
          <input type="checkbox" name="recent" value="1" {% if updated_recent %}checked{% endif %}>
          Updated last 7d
        </label>
      </div>
    </fieldset>

    <button type="submit" class="btn-primary rc-cta rc-cta-primary rc-cat-search-submit">
      Search
    </button>
  </form>
</section>


{# ------------------------------------------------------------------
   CATEGORY CHIPS
   categories -> iterable of {name,count,slug?}
------------------------------------------------------------------ #}
{% set categories = categories if categories is defined else [
  {'name':'All','count':0,'slug':'all'},
  {'name':'Business Rules','count':0,'slug':'business'},
  {'name':'Decision Trees','count':0,'slug':'decision'},
  {'name':'Process Flows','count':0,'slug':'process'},
  {'name':'State Machines','count':0,'slug':'state'},
  {'name':'Validation Rules','count':0,'slug':'validation'},
  {'name':'Templates','count':0,'slug':'templates'},
  {'name':'Archived','count':0,'slug':'archived'}
] %}
<section class="wrapper rc-container rc-section rc-catalog-catwrap">
  <h2 class="sr-only">Diagram Categories</h2>
  <div class="rc-catalog-cats rc-card rc-surface-1">
    <ul class="rc-catalog-catlist" role="list">
      {% for c in categories %}
        {% set active = request.args.get('cat','all') == c.slug %}
        <li>
          <a href="{{ url_for('main.catalog') }}?cat={{ c.slug }}{% if q %}&amp;q={{ q|urlencode }}{% endif %}"
             class="rc-catalog-cat {{ 'active' if active }}"
             aria-current="{{ 'page' if active }}">
            <span class="rc-catalog-cat-name">{{ c.name }}</span>
            {% if c.count %}
              <span class="rc-catalog-cat-count">{{ c.count }}</span>
            {% endif %}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>
</section>


{# ------------------------------------------------------------------
   RESULTS HEADER + SORT + VIEW
   sort -> request.args.get('sort','newest')
------------------------------------------------------------------ #}
{% set sort = request.args.get('sort','newest') %}
<section class="wrapper rc-container rc-section rc-catalog-resultswrap">
  {% set total_count = total_count if total_count is defined else (diagrams|length if diagrams is defined else 0) %}
  <div class="rc-catalog-results-head">
    <h2 class="rc-catalog-results-title">
      All Visualizations
      <span class="rc-catalog-results-count">({{ total_count }} result{{ '' if total_count == 1 else 's' }})</span>
    </h2>
    <div class="rc-catalog-results-controls">
      <div class="rc-catalog-sort">
        <label for="rc-cat-sort" class="sr-only">Sort by</label>
        <select id="rc-cat-sort" name="sort" form="rc-catalog-sortform" class="rc-catalog-sort-select">
          <option value="newest"        {% if sort=='newest' %}selected{% endif %}>Newest</option>
          <option value="oldest"        {% if sort=='oldest' %}selected{% endif %}>Oldest</option>
          <option value="az"            {% if sort=='az' %}selected{% endif %}>A–Z</option>
          <option value="za"            {% if sort=='za' %}selected{% endif %}>Z–A</option>
          <option value="most_fav"      {% if sort=='most_fav' %}selected{% endif %}>Most Favorited</option>
          <option value="most_viewed"   {% if sort=='most_viewed' %}selected{% endif %}>Most Viewed</option>
        </select>
      </div>
      <div class="rc-catalog-viewtoggles" role="group" aria-label="View toggle">
        <button type="button" id="rc-catalog-view-grid" class="rc-catalog-viewbtn active" aria-pressed="true" aria-label="Grid view">▦</button>
        <button type="button" id="rc-catalog-view-list" class="rc-catalog-viewbtn" aria-pressed="false" aria-label="List view">≣</button>
      </div>
    </div>
  </div>

{# ------------------------------------------------------------------
   RESULTS GRID + LIST
   diagrams -> iterable of diagram objects/dicts
------------------------------------------------------------------ #}
{% set diagrams = diagrams if diagrams is defined else [] %}
{% set page     = page|default(1) %}
{% set pages    = pages|default(1) %}

<div id="rc-catalog-grid" class="rc-catalog-grid">
  {% if diagrams %}
    {% for d in diagrams %}
      {% set d_id    = d.id    if d is mapping and 'id' in d else loop.index %}
      {% set d_name  = d.name  if d is mapping and 'name' in d else 'Diagram ' ~ loop.index %}
      {% set d_type  = d.type  if d is mapping and 'type' in d else 'Flowchart' %}
      {% set d_desc  = d.summary or d.description if d is mapping and ('summary' in d or 'description' in d) else '' %}
      {% set d_upd   = d.updated_human if d is mapping and 'updated_human' in d else '—' %}
      {% set d_tags  = d.tags if d is mapping and 'tags' in d else [] %}
      {% set d_auth  = d.author if d is mapping and 'author' in d else '' %}
      {% set d_url   = d.url if d is mapping and 'url' in d and d.url else (url_for('diagrams.diagrams_index') ~ '?id=' ~ d_id) %}
      <article class="rc-card rc-catalog-card rc-catalog-card-grid">
        <div class="rc-catalog-card-thumb">
          <a href="{{ d_url }}" class="rc-catalog-card-thumb-link" aria-label="Open {{ d_name }}">
            <div class="rc-catalog-card-thumb-img skeleton"></div>
          </a>
          <button type="button"
                  class="rc-catalog-favbtn"
                  data-diag-id="{{ d_id }}"
                  aria-pressed="false"
                  aria-label="Favorite diagram {{ d_name }}">♡</button>
        </div>
        <div class="rc-catalog-card-body">
          <div class="rc-catalog-card-type">{{ d_type }}</div>
          <h3 class="rc-catalog-card-title">
            <a href="{{ d_url }}">{{ d_name }}</a>
          </h3>
          {% if d_desc %}
            <p class="rc-catalog-card-desc">{{ d_desc }}</p>
          {% endif %}
          <div class="rc-catalog-card-updated">{{ d_upd }}</div>
          <div class="rc-catalog-card-action">
            <a href="{{ d_url }}" class="btn-primary rc-cta w-full text-center">Preview</a>
          </div>
        </div>
      </article>
    {% endfor %}
  {% else %}
    <div class="rc-card rc-catalog-empty p-10 text-center" role="alert">
      <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200">No diagrams found</h3>
      <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Try adjusting your search or filter criteria.</p>
      <a href="{{ url_for('main.catalog') }}" class="btn-primary rc-cta mt-4 inline-block">Reset Search &amp; Filters</a>
    </div>
  {% endif %}
</div>


<div id="rc-catalog-list" class="rc-catalog-list" hidden>
  {% if diagrams %}
    {% for d in diagrams %}
      {% set d_id    = d.id    if d is mapping and 'id' in d else loop.index %}
      {% set d_name  = d.name  if d is mapping and 'name' in d else 'Diagram ' ~ loop.index %}
      {% set d_type  = d.type  if d is mapping and 'type' in d else 'Flowchart' %}
      {% set d_desc  = d.summary or d.description if d is mapping and ('summary' in d or 'description' in d) else '' %}
      {% set d_upd   = d.updated_human if d is mapping and 'updated_human' in d else '—' %}
      {% set d_tags  = d.tags if d is mapping and 'tags' in d else [] %}
      {% set d_auth  = d.author if d is mapping and 'author' in d else '' %}
      {% set d_url   = d.url if d is mapping and 'url' in d and d.url else (url_for('diagrams.diagrams_index') ~ '?id=' ~ d_id) %}
      <article class="rc-card rc-catalog-card rc-catalog-card-list">
        <div class="rc-catalog-card-listthumb">
          <a href="{{ d_url }}" aria-label="Open {{ d_name }}">
            <div class="rc-catalog-card-thumb-img skeleton"></div>
          </a>
          <button type="button"
                  class="rc-catalog-favbtn"
                  data-diag-id="{{ d_id }}"
                  aria-pressed="false"
                  aria-label="Favorite diagram {{ d_name }}">♡</button>
        </div>
        <div class="rc-catalog-card-listbody">
          <div class="rc-catalog-card-listmeta">
            <span class="rc-catalog-card-type">{{ d_type }}</span>
            <span class="rc-catalog-card-updated">{{ d_upd }}</span>
          </div>
          <h3 class="rc-catalog-card-title"><a href="{{ d_url }}">{{ d_name }}</a></h3>
          {% if d_desc %}
            <p class="rc-catalog-card-desc">{{ d_desc }}</p>
          {% endif %}
          {% if d_tags %}
            <ul class="rc-catalog-card-tags" role="list">
              {% for tag in d_tags %}
                <li>{{ tag }}</li>
              {% endfor %}
            </ul>
          {% endif %}
          {% if d_auth %}
            <div class="rc-catalog-card-author">by {{ d_auth }}</div>
          {% endif %}
          <div class="rc-catalog-card-listactions">
            <a href="{{ d_url }}" class="btn-primary rc-cta">Preview</a>
            <a href="{{ d_url }}&amp;download=1" class="btn-secondary rc-cta">Download</a>
          </div>
        </div>
      </article>
    {% endfor %}
  {% endif %}
</div>


{# ------------------------------------------------------------------
   PAGINATION
------------------------------------------------------------------ #}
{% if pages > 1 %}
  <nav class="rc-catalog-pager" role="navigation" aria-label="Pagination">
    {% set prev_disabled = page <= 1 %}
    {% set next_disabled = page >= pages %}
    {% set base_qs = '&amp;'.join(request.query_string.decode().split('&amp;') if request.query_string else []) %}
    {% macro page_link(p,label=None) %}
      {% set label = label or p %}
      <a href="{{ url_for('main.catalog', **request.args.to_dict(flat=False)) }}{% if p %}?page={{ p }}{% endif %}"
         class="rc-catalog-pagebtn">{{ label }}</a>
    {% endmacro %}
    <div class="rc-catalog-pager-inner">
      {% if prev_disabled %}
        <span class="rc-catalog-pagebtn rc-catalog-pagebtn-disabled">Previous</span>
      {% else %}
        <a href="{{ url_for('main.catalog', page=page-1, **request.args.to_dict(flat=False)) }}" class="rc-catalog-pagebtn">Previous</a>
      {% endif %}

      {% for p in range(1, pages+1) %}
        {% if p == page %}
          <span class="rc-catalog-pagebtn rc-catalog-pagebtn-active">{{ p }}</span>
        {% else %}
          <a href="{{ url_for('main.catalog', page=p, **request.args.to_dict(flat=False)) }}" class="rc-catalog-pagebtn">{{ p }}</a>
        {% endif %}
      {% endfor %}

      {% if next_disabled %}
        <span class="rc-catalog-pagebtn rc-catalog-pagebtn-disabled">Next</span>
      {% else %}
        <a href="{{ url_for('main.catalog', page=page+1, **request.args.to_dict(flat=False)) }}" class="rc-catalog-pagebtn">Next</a>
      {% endif %}
    </div>
  </nav>
{% endif %}
</section>

{% endblock content %}


{# ------------------------------------------------------------------
   STYLES
------------------------------------------------------------------ #}
{% block styles %}
{% endblock styles %}


{# ------------------------------------------------------------------
   SCRIPTS
------------------------------------------------------------------ #}
{% block scripts %}
  {{ super() }}
  <script>
  // Catalog behavior: grid/list toggle, ctrl+k focus, sync filters, persist view in localStorage
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput   = document.getElementById('rc-cat-search');
    const gridBtn       = document.getElementById('rc-catalog-view-grid');
    const listBtn       = document.getElementById('rc-catalog-view-list');
    const gridWrap      = document.getElementById('rc-catalog-grid');
    const listWrap      = document.getElementById('rc-catalog-list');
    const sortSelect    = document.getElementById('rc-cat-sort');
    const filterOpenBtn = document.getElementById('rc-cat-filter-open');

    // Ctrl+K focus search
    window.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){
        e.preventDefault();
        searchInput?.focus();
      }
    });

    // Persisted view
    const VIEW_KEY = 'rc_catalog_view';
    function applyView(v){
      const isGrid = v !== 'list';
      gridWrap.hidden = !isGrid;
      listWrap.hidden = isGrid;
      gridBtn.classList.toggle('active', isGrid);
      gridBtn.setAttribute('aria-pressed', isGrid);
      listBtn.classList.toggle('active', !isGrid);
      listBtn.setAttribute('aria-pressed', !isGrid);
      localStorage.setItem(VIEW_KEY, isGrid ? 'grid' : 'list');
    }
    gridBtn?.addEventListener('click',()=>applyView('grid'));
    listBtn?.addEventListener('click',()=>applyView('list'));
    applyView(localStorage.getItem(VIEW_KEY) || 'grid');

    // Auto-submit on sort change
    sortSelect?.addEventListener('change', ()=>{
      // rebuild URL w/ existing params but new sort
      const url = new URL(window.location.href);
      url.searchParams.set('sort', sortSelect.value);
      window.location.href = url.toString();
    });

    // Mobile filters drawer (simple prompt fallback)
    filterOpenBtn?.addEventListener('click', ()=>{
      alert('Filters available on larger screens. Use desktop for full filtering.');
    });
  });
  </script>
{% endblock scripts %}