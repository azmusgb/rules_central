{% extends "base.html" %}

{% block title %}Rules Central{% endblock %}

{% block meta %}
<meta name="description" content="Comprehensive dashboard for managing and analyzing business rules with key metrics and visualization tools.">
{% endblock %}

{% block hero %}
<section aria-labelledby="hero-heading" class="hero-section">
    <div class="container mx-auto px-4 py-20 text-center">
        <h1 id="hero-heading" class="hero-title">Rules Central</h1>
        <p class="hero-subtitle">Key metrics and insights about your rules ecosystem</p>
        <div class="mt-8">
            <a href="/search" class="hero-cta-btn">
                Explore Dashboard
                <span class="sr-only">Navigate to the dashboard explorer</span>
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<!-- Performance Metrics Section -->
<section aria-labelledby="metrics-heading" class="metrics-section">
    <div class="container mx-auto px-4 py-12">
        <h2 id="metrics-heading" class="section-heading sr-only">Performance Metrics</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="metricsContainer">
            {% set metrics = [
                ['fa-project-diagram', 'Diagrams Processed', 'diagramCount', 'primary', 75, 100],
                ['fa-sitemap', 'Rules Extracted', 'rulesExtractedCount', 'emerald', 65, 200],
                ['fa-tasks', 'Rules by Status', 'rulesStatusChart', 'green', 80, 300],
                ['fa-history', 'Recent Changes', 'recentChangesCount', 'purple', 50, 400]
            ] %}
            
            {% for icon, label, id, color, progress, delay in metrics %}
            <div class="metric-card animate-on-scroll" 
                 data-metric-id="{{ id }}"
                 data-delay="{{ delay }}"
                 aria-labelledby="{{ id }}-label {{ id }}-value">
                <div class="metric-icon-container">
                    <i class="fas {{ icon }} metric-icon" aria-hidden="true"></i>
                </div>
                <div class="metric-content">
                    <span id="{{ id }}-label" class="metric-label">{{ label }}</span>
                    <div class="metric-value-container">
                        <span id="{{ id }}-value" class="metric-value" aria-live="polite">
                            <span class="sr-only">Loading</span>
                            <span class="countup">0</span>
                        </span>
                        <span class="metric-trend-indicator" data-trend="up">
                            <i class="fas fa-arrow-up" aria-hidden="true"></i>
                            <span class="sr-only">Increasing</span>
                        </span>
                    </div>
                    <div class="metric-progress-container">
                        <div class="metric-progress-bar" 
                             style="--progress: {{ progress }}%; --progress-color: var(--color-{{ color }});"
                             aria-hidden="true">
                        </div>
                        <span class="sr-only">Progress: {{ progress }}%</span>
                    </div>
                </div>
                <div class="metric-loading-state">
                    <div class="loading-spinner" aria-hidden="true"></div>
                    <span class="sr-only">Loading {{ label }} data</span>
                </div>
                <div class="metric-error-state">
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                        <span>Failed to load</span>
                    </div>
                    <button class="retry-btn" 
                            aria-label="Retry loading {{ label }} data"
                            data-metric="{{ id }}">
                        <i class="fas fa-sync-alt" aria-hidden="true"></i> Retry
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Features Section -->
<section aria-labelledby="features-heading" class="features-section">
    <div class="container mx-auto px-4 py-16">
        <div class="section-header">
            <h2 id="features-heading" class="section-heading">Powerful Features</h2>
            <p class="section-subheading">Manage, analyze, and visualize rules efficiently</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% set features = [
                ['fa-upload', 'Create & Upload', 'Upload diagrams with automatic validation and processing', '/upload'],
                ['fa-search', 'Explore & Analyze', 'Advanced query tools with visual rule exploration', '/search'],
                ['fa-tools', 'Tools & Utilities', 'Comprehensive testing and customization utilities', '/api_test_utility']
            ] %}
            
            {% for icon, title, desc, link in features %}
            <article class="feature-card animate-on-scroll" data-delay="{{ loop.index * 100 }}">
                <div class="feature-icon-container">
                    <i class="fas {{ icon }}" aria-hidden="true"></i>
                </div>
                <h3 class="feature-title">{{ title }}</h3>
                <p class="feature-description">{{ desc }}</p>
                <a href="{{ link }}" class="feature-link" aria-label="Learn more about {{ title }}">
                    Explore feature
                    <i class="fas fa-chevron-right" aria-hidden="true"></i>
                </a>
            </article>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Quick Start Section -->
<section aria-labelledby="quickstart-heading" class="quickstart-section">
    <div class="container mx-auto px-4 py-16">
        <div class="section-header">
            <h2 id="quickstart-heading" class="section-heading">Get Started in Minutes</h2>
            <p class="section-subheading">Three simple steps to unleash the power of Rules Central</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {% set steps = [
                ['fa-upload', '1. Upload Diagrams', 'Import your diagrams or data using our intuitive upload tool with automatic validation'],
                ['fa-magic', '2. Extract Rules', 'Our system automatically processes and extracts rules from your diagrams'],
                ['fa-chart-line', '3. Visualize Results', 'Explore insights with our interactive dashboards and reporting tools']
            ] %}
            
            {% for icon, title, desc in steps %}
            <div class="step-card animate-on-scroll" data-delay="{{ loop.index * 100 }}">
                <div class="step-number">{{ loop.index }}</div>
                <div class="step-icon-container">
                    <i class="fas {{ icon }}" aria-hidden="true"></i>
                </div>
                <h3 class="step-title">{{ title }}</h3>
                <p class="step-description">{{ desc }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Loading Overlay -->
<div id="globalLoader" class="loading-overlay" aria-live="assertive" aria-busy="true">
    <div class="loading-content">
        <div class="loading-spinner" aria-hidden="true"></div>
        <p class="loading-text">Loading Dashboard</p>
        <div class="loading-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Performance metrics data
    const METRICS_API_ENDPOINT = '/api/stats';
    const METRIC_UPDATE_INTERVAL = 300000; // 5 minutes
    
    // Initialize loader
    const initLoader = () => {
        const loader = document.getElementById('globalLoader');
        if (!loader) return;
        
        // Simulate progress for better UX
        let progress = 0;
        const progressBar = loader.querySelector('.loading-progress');
        const interval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                setTimeout(() => {
                    loader.classList.add('fade-out');
                    setTimeout(() => loader.remove(), 500);
                }, 300);
            }
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
        }, 100);
    };
    
    // Animate values with easing
    const animateValue = (element, start, end, duration) => {
        const startTime = performance.now();
        const formatNumber = (num) => num.toLocaleString();
        
        const updateValue = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easedProgress = progress < 0.5 
                ? 2 * progress * progress 
                : 1 - Math.pow(-2 * progress + 2, 2) / 2;
            
            const currentValue = Math.floor(start + (end - start) * easedProgress);
            element.textContent = formatNumber(currentValue);
            
            if (progress < 1) {
                requestAnimationFrame(updateValue);
            } else {
                element.textContent = formatNumber(end);
            }
        };
        
        requestAnimationFrame(updateValue);
    };
    
    // Fetch metrics data
    const fetchMetricsData = async () => {
        try {
            const response = await fetch(METRICS_API_ENDPOINT, {
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('Failed to fetch metrics:', error);
            throw error;
        }
    };
    
    // Update metric cards with data
    const updateMetrics = (data) => {
        const metricCards = document.querySelectorAll('[data-metric-id]');
        
        metricCards.forEach(card => {
            const metricId = card.dataset.metricId;
            const valueElement = card.querySelector('.metric-value .countup');
            const loadingState = card.querySelector('.metric-loading-state');
            const errorState = card.querySelector('.metric-error-state');
            
            try {
                let value;
                switch(metricId) {
                    case 'diagramCount':
                        value = data.diagramsProcessed || 0;
                        break;
                    case 'rulesExtractedCount':
                        value = data.rulesExtracted || 0;
                        break;
                    case 'rulesStatusChart':
                        value = Object.values(data.rules_by_status || {}).reduce((a, b) => a + b, 0);
                        break;
                    case 'recentChangesCount':
                        value = data.recent_changes || 0;
                        break;
                    default:
                        value = 0;
                }
                
                // Animate the value
                if (valueElement) {
                    const currentValue = parseInt(valueElement.textContent.replace(/,/g, '')) || 0;
                    animateValue(valueElement, currentValue, value, 1500);
                }
                
                // Update progress bar animation
                const progressBar = card.querySelector('.metric-progress-bar');
                if (progressBar) {
                    progressBar.style.setProperty('--progress-animated', progressBar.style.getPropertyValue('--progress'));
                }
                
                // Hide loading state
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) errorState.classList.add('hidden');
                
            } catch (error) {
                console.error(`Error updating metric ${metricId}:`, error);
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) errorState.classList.remove('hidden');
            }
        });
    };
    
    // Initialize intersection observer for scroll animations
    const initScrollAnimations = () => {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-in');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        
        document.querySelectorAll('.animate-on-scroll').forEach(el => {
            const delay = el.dataset.delay || 0;
            el.style.setProperty('--animation-delay', `${delay}ms`);
            observer.observe(el);
        });
    };
    
    // Set up metric refresh
    const setupMetricRefresh = () => {
        let refreshTimer;
        
        const refreshMetrics = async () => {
            try {
                const data = await fetchMetricsData();
                updateMetrics(data);
            } catch (error) {
                console.error('Failed to refresh metrics:', error);
            } finally {
                refreshTimer = setTimeout(refreshMetrics, METRIC_UPDATE_INTERVAL);
            }
        };
        
        // Initial load
        refreshMetrics();
        
        // Clean up on page hide
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearTimeout(refreshTimer);
            } else {
                refreshMetrics();
            }
        });
    };
    
    // Initialize retry functionality
    const initRetryHandlers = () => {
        document.querySelectorAll('.retry-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const metricId = btn.dataset.metric;
                const card = btn.closest('.metric-card');
                const loadingState = card?.querySelector('.metric-loading-state');
                const errorState = card?.querySelector('.metric-error-state');
                
                if (loadingState) loadingState.classList.remove('hidden');
                if (errorState) errorState.classList.add('hidden');
                
                try {
                    const data = await fetchMetricsData();
                    updateMetrics(data);
                } catch (error) {
                    if (loadingState) loadingState.classList.add('hidden');
                    if (errorState) errorState.classList.remove('hidden');
                }
            });
        });
    };
    
    // Initialize everything
    initLoader();
    initScrollAnimations();
    setupMetricRefresh();
    initRetryHandlers();
    
    // Load initial data
    fetchMetricsData()
        .then(updateMetrics)
        .catch(error => {
            console.error('Initial metrics load failed:', error);
            document.querySelectorAll('.metric-error-state').forEach(el => {
                el.classList.remove('hidden');
            });
        });
});
</script>

<style>
:root {
    /* Color variables */
    --color-primary: #3b82f6;
    --color-primary-light: #60a5fa;
    --color-emerald: #10b981;
    --color-green: #22c55e;
    --color-purple: #a78bfa;
    --color-dark-800: #1e293b;
    --color-dark-700: #334155;
    --color-dark-600: #475569;
    --color-gray-400: #94a3b8;
    --color-gray-300: #cbd5e1;
    
    /* Animation variables */
    --animation-duration: 0.6s;
    --animation-easing: cubic-bezier(0.16, 1, 0.3, 1);
}

/* Base styles */
.section-header {
    @apply text-center mb-12;
}

.section-heading {
    @apply text-3xl font-bold mb-2 text-white;
}

.section-subheading {
    @apply text-gray-400 max-w-2xl mx-auto;
}

/* Hero section styles */
.hero-section {
    @apply bg-gradient-to-r from-dark-800 to-dark-700 py-24 relative overflow-hidden;
}

.hero-title {
    @apply text-5xl md:text-6xl font-bold text-white mb-4;
}

.hero-subtitle {
    @apply text-xl text-gray-300 max-w-2xl mx-auto;
}

.hero-cta-btn {
    @apply inline-block bg-primary-500 hover:bg-primary-400 text-white font-medium px-8 py-3 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary-400 focus:ring-offset-2 focus:ring-offset-dark-800;
}

/* Metric card styles */
.metrics-section {
    @apply relative;
}

.metric-card {
    @apply bg-dark-700 border border-gray-800 rounded-xl p-6 relative overflow-hidden transition-all duration-300 hover:border-primary-500 hover:shadow-lg;
    opacity: 0;
    transform: translateY(20px);
}

.metric-card.animate-in {
    opacity: 1;
    transform: translateY(0);
    transition: opacity var(--animation-duration) var(--animation-easing), 
                transform var(--animation-duration) var(--animation-easing);
    transition-delay: var(--animation-delay, 0ms);
}

.metric-icon-container {
    @apply w-12 h-12 rounded-full bg-opacity-20 flex items-center justify-center mb-4;
    background-color: var(--metric-color, var(--color-primary));
}

.metric-icon {
    @apply text-2xl;
    color: var(--metric-color, var(--color-primary));
}

.metric-label {
    @apply text-gray-400 text-sm font-medium block mb-1;
}

.metric-value-container {
    @apply flex items-baseline gap-2 mb-2;
}

.metric-value {
    @apply text-3xl font-bold text-white;
}

.metric-trend-indicator {
    @apply text-xs px-2 py-1 rounded-full bg-opacity-20 flex items-center;
    background-color: var(--color-emerald);
    color: var(--color-emerald);
}

.metric-progress-container {
    @apply h-2 bg-dark-600 rounded-full overflow-hidden mt-4;
}

.metric-progress-bar {
    @apply h-full rounded-full;
    width: 0%;
    background-color: var(--progress-color, var(--color-primary));
    transition: width 1.5s var(--animation-easing);
}

.metric-card:hover .metric-progress-bar {
    width: var(--progress-animated, var(--progress, 0%));
}

.metric-loading-state {
    @apply absolute inset-0 bg-dark-800 bg-opacity-90 flex items-center justify-center;
}

.metric-error-state {
    @apply absolute inset-0 bg-dark-800 bg-opacity-90 flex flex-col items-center justify-center hidden;
}

.retry-btn {
    @apply mt-2 text-sm text-primary-500 hover:text-primary-400 transition-colors;
}

/* Feature card styles */
.features-section {
    @apply bg-dark-800 bg-opacity-50;
}

.feature-card {
    @apply bg-dark-700 border border-gray-800 rounded-xl p-8 flex flex-col h-full transition-all duration-300 hover:border-primary-500 hover:shadow-lg;
    opacity: 0;
    transform: translateY(20px);
}

.feature-card.animate-in {
    opacity: 1;
    transform: translateY(0);
    transition: opacity var(--animation-duration) var(--animation-easing), 
                transform var(--animation-duration) var(--animation-easing);
    transition-delay: var(--animation-delay, 0ms);
}

.feature-icon-container {
    @apply w-16 h-16 rounded-full bg-primary-500 bg-opacity-20 flex items-center justify-center mb-6 text-primary-400 text-2xl transition-all duration-300;
}

.feature-card:hover .feature-icon-container {
    @apply bg-opacity-30 transform scale-110;
}

.feature-title {
    @apply text-xl font-semibold text-white mb-3;
}

.feature-description {
    @apply text-gray-400 mb-6 flex-grow;
}

.feature-link {
    @apply text-primary-400 hover:text-primary-300 inline-flex items-center group transition-colors mt-auto;
}

.feature-link i {
    @apply transition-transform duration-300 ml-2;
}

.feature-link:hover i {
    @apply transform translate-x-1;
}

/* Quick start section styles */
.quickstart-section {
    @apply bg-dark-900;
}

.step-card {
    @apply bg-dark-700 border border-gray-800 rounded-xl p-8 text-center relative overflow-hidden transition-all duration-300 hover:shadow-lg;
    opacity: 0;
    transform: translateY(20px);
}

.step-card.animate-in {
    opacity: 1;
    transform: translateY(0);
    transition: opacity var(--animation-duration) var(--animation-easing), 
                transform var(--animation-duration) var(--animation-easing);
    transition-delay: var(--animation-delay, 0ms);
}

.step-number {
    @apply absolute top-4 right-4 text-4xl font-bold text-gray-800;
}

.step-icon-container {
    @apply w-16 h-16 rounded-full bg-primary-500 bg-opacity-20 flex items-center justify-center mx-auto mb-6 text-primary-400 text-2xl;
}

.step-title {
    @apply text-xl font-semibold text-white mb-3;
}

.step-description {
    @apply text-gray-400;
}

/* Loading overlay styles */
.loading-overlay {
    @apply fixed inset-0 bg-dark-900 bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-500;
}

.loading-content {
    @apply text-center max-w-xs;
}

.loading-spinner {
    @apply w-16 h-16 border-4 border-primary-500 border-t-transparent rounded-full animate-spin mx-auto mb-4;
}

.loading-text {
    @apply text-gray-300 mb-2;
}

.loading-progress {
    @apply h-1 bg-gray-800 rounded-full overflow-hidden;
}

.loading-progress::after {
    @apply block h-full bg-primary-500;
    content: '';
}

.fade-out {
    @apply opacity-0 pointer-events-none;
}

/* Animations */
@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}