{% extends "base.html" %}
{% block title %}Dashboard | Rules Central{% endblock %}

{% block content %}

<!-- HERO --------------------------------------------------- -->
<section class="wrapper rc-container rc-section pt-12 md:pt-20 pb-16 md:pb-24 text-center relative overflow-hidden rc-hero">
  <div class="absolute inset-0 rc-hero-bg pointer-events-none" aria-hidden="true"></div>
  <div class="relative z-10 space-y-6 md:space-y-8">
    <div class="inline-flex items-center gap-2 px-5 py-2 rounded-full border border-primary-200/40 dark:border-primary-500/30 bg-primary-50/60 dark:bg-primary-500/10 backdrop-blur-sm shadow-sm">
      <span class="w-2 h-2 rounded-full bg-primary-500 animate-ping"></span>
      <span class="text-sm font-semibold tracking-wide uppercase text-primary-700 dark:text-primary-300">Rules Management Dashboard</span>
    </div>
    <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight leading-tight bg-gradient-to-br from-primary-500 to-primary-700 dark:from-primary-300 dark:to-primary-500 bg-clip-text text-transparent">
      Rules Central
    </h1>
    <p class="text-lg md:text-xl text-slate-600 dark:text-slate-300 max-w-2xl mx-auto leading-relaxed">
      Manage your rules effortlessly with real-time insights, key metrics, and streamlined workflows.
    </p>
    <div class="flex flex-wrap justify-center gap-4 pt-2">
      <a href="{{ url_for('routes.config_page') }}" class="btn-primary rc-cta rc-cta-primary">
        <i class="fas fa-plus mr-2" aria-hidden="true"></i> New Rule
      </a>
      <a href="{{ url_for('main.catalog') }}" class="btn-secondary rc-cta">
        <i class="fas fa-table-list mr-2" aria-hidden="true"></i> View Catalog
      </a>
      <a href="#quick-tour" class="btn-tertiary rc-cta">
        <i class="fas fa-play mr-2" aria-hidden="true"></i> Quick Tour
      </a>
    </div>
  </div>
</section>


<!-- METRICS ------------------------------------------------ -->
<section id="metrics" class="wrapper rc-container rc-section py-10 md:py-14 space-y-6 animate__animated animate__fadeInUp">
  <div class="flex items-center justify-between flex-wrap gap-4">
    <h2 class="text-xl font-semibold text-slate-800 dark:text-slate-200 flex items-center gap-2">
      <i class="fas fa-chart-simple text-primary-500"></i>
      <span>Key Metrics</span>
    </h2>
    <div class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 flex items-center gap-1">
      <i class="fas fa-clock"></i>
      Last updated: <span class="font-medium">{{ now().strftime('%b %d, %Y %I:%M %p') }}</span>
      <button id="metrics-refresh" class="ml-2 text-primary-600 dark:text-primary-400 hover:underline">Refresh</button>
    </div>
  </div>

  {% macro metric_card(title, value, icon, accent_classes='', trend=None, link=None) %}
    <div class="rc-card rc-metric group {{ 'hover:ring-2 hover:ring-primary-500 cursor-pointer focus-within:ring-2' if link }}">
      {% if link %}
        <a href="{{ link }}" class="absolute inset-0 z-10 sr-only-focusable" aria-label="{{ title }}"></a>
      {% endif %}
      <div class="p-5 relative z-0">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">{{ title }}</p>
            <p class="rc-metric-value text-4xl sm:text-3xl font-bold text-slate-800 dark:text-slate-100 leading-none">{{ value|default(0) }}</p>
          </div>
          <div class="rc-metric-icon {{ accent_classes }}">
            <i class="{{ icon }} text-lg"></i>
          </div>
        </div>
        {% if trend is not none %}
          {% if trend is mapping %}
            {% set pct = trend.get('pct', 0) %}
            {% set up = trend.get('is_up', pct >= 0) %}
            <p class="mt-3 text-xs font-medium {{ 'text-emerald-600 dark:text-emerald-400' if up else 'text-rose-600 dark:text-rose-400' }}">
              {{ pct|round(1) }}% vs previous
            </p>
          {% else %}
            <p class="mt-3 text-xs text-slate-500 dark:text-slate-400">{{ trend }}</p>
          {% endif %}
        {% else %}
          <p class="mt-3 text-xs text-transparent select-none" aria-hidden="true">&nbsp;</p>
        {% endif %}
      </div>
    </div>
  {% endmacro %}

  <div class="grid rc-grid-auto rc-metrics-grid gap-5 sm:grid-cols-2 lg:grid-cols-4">
    {{ metric_card('Total Rules',
                   stats.total_rules if stats and 'total_rules' in stats else 0,
                   'fas fa-layer-group','rc-accent-primary',None,
                   url_for('main.catalog')) }}

    {{ metric_card('Changed (7d)',
                   stats.changed_7d if stats and 'changed_7d' in stats else 0,
                   'fas fa-calendar-week','rc-accent-amber',
                   stats.trend_7d if stats and 'trend_7d' in stats else None,
                   url_for('main.catalog') ~ '?range=7d') }}

    {{ metric_card('Changed (30d)',
                   stats.changed_30d if stats and 'changed_30d' in stats else 0,
                   'fas fa-calendar-days','rc-accent-rose',
                   stats.trend_30d if stats and 'trend_30d' in stats else None,
                   url_for('main.catalog') ~ '?range=30d') }}

    {{ metric_card('Changed (90d)',
                   stats.changed_90d if stats and 'changed_90d' in stats else 0,
                   'fas fa-calendar','rc-accent-indigo',
                   stats.trend_90d if stats and 'trend_90d' in stats else None,
                   url_for('main.catalog') ~ '?range=90d') }}
  </div>
</section>


<!-- TREND + ACTIVITY --------------------------------------- -->
<section class="wrapper rc-container rc-section pb-12 md:pb-20">
  <div class="grid rc-grid-2-1 gap-6 lg:grid-cols-3">
    <!-- Trend -->
    <section aria-labelledby="trend-heading" class="lg:col-span-2 space-y-4 rc-card rc-surface-1 p-5 animate__animated animate__fadeIn">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <h2 id="trend-heading" class="text-xl font-semibold text-slate-800 dark:text-slate-200 flex items-center gap-2">
          <i class="fas fa-chart-line text-primary-500"></i>
          <span>Rule Change Trends</span>
        </h2>
        <div class="flex gap-2 p-1 rc-toggle-pill">
          <button data-range="7d"  class="rc-toggle active">7D</button>
          <button data-range="30d" class="rc-toggle">30D</button>
          <button data-range="90d" class="rc-toggle">90D</button>
          <button data-range="1y"  class="rc-toggle">1Y</button>
        </div>
      </div>
      <div class="w-full h-[280px]">
        <canvas id="rulesTrendChart" aria-label="Rule change trends chart" role="img"></canvas>
      </div>
      <div class="flex flex-wrap gap-4 justify-between items-center pt-2 text-sm">
        <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
          <span class="w-3 h-3 rounded-full bg-primary-500"></span>
          <span>Rule changes</span>
        </div>
        <div class="flex gap-4">
          <button class="text-slate-500 dark:text-slate-400 hover:text-primary-500 transition-colors">
            <i class="fas fa-download mr-1"></i> Export
          </button>
          <button class="text-slate-500 dark:text-slate-400 hover:text-primary-500 transition-colors">
            <i class="fas fa-expand mr-1"></i> Fullscreen
          </button>
        </div>
      </div>
    </section>

    <!-- Recent Activity -->
    <section aria-labelledby="activity-heading" class="space-y-4 rc-card rc-surface-1 p-5 animate__animated animate__fadeIn">
      <h2 id="activity-heading" class="text-xl font-semibold text-slate-800 dark:text-slate-200 flex items-center gap-2">
        <i class="fas fa-clock-rotate-left text-primary-500"></i>
        <span>Recent Activity</span>
      </h2>

      {% macro activity_item(icon, accent_classes, action, user, time, rule=None) %}
        <div class="flex gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/40 transition-all duration-150 hover:shadow-sm">
          <div class="flex-shrink-0 mt-1">
            <div class="w-9 h-9 rounded-lg flex items-center justify-center rc-activity-icon {{ accent_classes }}">
              <i class="{{ icon }}"></i>
            </div>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-slate-800 dark:text-slate-200 truncate">
              {{ action }}
              {% if rule %}
                <a href="#" class="text-primary-600 dark:text-primary-400 hover:underline">"{{ rule }}"</a>
              {% endif %}
            </p>
            <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 mt-1">
              <span>{{ user }}</span>
              <span class="w-1 h-1 rounded-full bg-slate-300 dark:bg-slate-600"></span>
              <span>{{ time }}</span>
            </div>
          </div>
        </div>
      {% endmacro %}

      <div class="space-y-3 max-h-[360px] overflow-y-auto pr-1 -mr-1 rc-scroll">
        {{ activity_item('fas fa-plus','rc-accent-emerald','Created new rule','John D.','2 minutes ago','Payment Processing Rule') }}
        {{ activity_item('fas fa-pen','rc-accent-amber','Updated rule','Sarah M.','15 minutes ago','Fraud Detection Rule') }}
        {{ activity_item('fas fa-trash','rc-accent-rose','Deleted rule','Alex T.','1 hour ago','Old Compliance Rule') }}
        {{ activity_item('fas fa-file-import','rc-accent-violet','Imported rules','System','2 hours ago') }}
        {{ activity_item('fas fa-check','rc-accent-primary','Approved changes','Lisa K.','5 hours ago','3 rules') }}

        <div class="text-center pt-2">
          <a href="#" class="text-sm font-medium text-primary-600 dark:text-primary-400 hover:underline inline-flex items-center">
            View all activity
            <i class="fas fa-chevron-right ml-1 text-xs"></i>
          </a>
        </div>
      </div>
    </section>
  </div>
</section>


<!-- QUICK ACTIONS ----------------------------------------- -->
<section id="quick-actions" aria-labelledby="actions-heading" class="wrapper rc-container rc-section py-12 md:py-20 space-y-10 animate__animated animate__fadeIn rc-quick-actions">
  <h2 id="actions-heading" class="text-2xl font-bold text-slate-800 dark:text-slate-200 flex items-center gap-3">
    <i class="fas fa-bolt text-primary-500 text-xl"></i>
    <span>Quick Actions &amp; Tools</span>
  </h2>

  {% macro quick_action(icon, accent_classes, text, description, url) %}
    <a href="{{ url }}"
       class="flex flex-col gap-4 p-6 rounded-2xl rc-card rc-qa-card group hover:-translate-y-1 hover:shadow-xl transition-all duration-200">
      <div class="flex items-center justify-between">
        <div class="w-12 h-12 rounded-xl flex items-center justify-center rc-qa-icon {{ accent_classes }} group-hover:scale-110 transition-transform duration-200">
          <i class="{{ icon }} text-xl"></i>
        </div>
        <i class="fas fa-arrow-right text-slate-300 dark:text-slate-600 group-hover:text-primary-500 transition-colors"></i>
      </div>
      <div>
        <h3 class="text-lg font-semibold group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">{{ text }}</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">{{ description }}</p>
      </div>
    </a>
  {% endmacro %}

  <div class="grid rc-grid-auto rc-qa-grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
    {{ quick_action('fas fa-file-arrow-up','rc-accent-violet','Import Rules','Bulk import from CSV/Excel', url_for('upload.upload_file')) }}
    {{ quick_action('fas fa-diagram-project','rc-accent-amber','Generate Diagram','Visualize rule relationships', url_for('diagrams.diagram_converter')) }}
    {{ quick_action('fas fa-book','rc-accent-blue','Documentation','Guides &amp; API references','#') }}
  </div>

  <!-- Onboarding Callout -->
  <div class="mt-12 relative overflow-hidden rounded-2xl rc-onboard text-white p-8 md:p-10 shadow-xl">
    <div aria-hidden="true" class="absolute inset-0 rc-onboard-bg"></div>
    <div class="relative z-10 space-y-3 md:space-y-4 max-w-xl">
      <h3 class="text-2xl font-bold">Need help getting started?</h3>
      <p class="text-base md:text-lg opacity-90">Explore our tutorials and documentation to make the most of Rules Central.</p>
      <div class="flex flex-wrap gap-4 pt-2">
        <a href="#quick-tour" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white font-medium transition-colors">
          <i class="fas fa-play"></i> Watch Tutorial
        </a>
        <a href="#" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white font-medium transition-colors">
          <i class="fas fa-book"></i> Documentation
        </a>
      </div>
    </div>
  </div>
</section>

{% endblock %}


{% block styles %}
{% endblock %}


{% block scripts %}
  {{ super() }}
  <script defer src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggles = document.querySelectorAll('.rc-toggle-pill .rc-toggle');
      toggles.forEach(btn => {
        btn.addEventListener('click', () => {
          toggles.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          // TODO: AJAX update chart range
        });
      });
    });
  </script>
{% endblock %}