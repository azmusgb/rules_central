{% extends "base.html" %}
{% block title %}Settings | Rules Central{% endblock %}
{% block hero_title %}Settings{% endblock %}
{% block hero_subtitle %}Personalize your Rules Central experience. All changes are saved instantly.{% endblock %}
{% block content %}
<div
  class="flex flex-col items-center justify-center w-full px-4"
  x-data="{ isLoading: false, showSuccess: {{ 'true' if settings_saved else 'false' }} }"
  x-init="
    setTimeout(() => showSuccess = false, 5000);
    $watch('showSuccess', value => if (value) { showToast = true; toastMsg = 'Settings saved successfully!' });
  "
>
  <form
    class="w-full max-w-3xl flex flex-col gap-12"
    method="post"
    enctype="multipart/form-data"
    aria-label="Settings form"
    @submit="isLoading = true"
  >
    <!-- Profile Section -->
    <div
      class="card--glass p-10"
      data-aos="fade-up"
      data-aos-delay="100"
    >
      <div class="flex items-center gap-6 mb-6">
        <label for="avatar" class="relative group cursor-pointer">
          <img
            src="{{ user.avatar_url or url_for('static', filename='images/favicon.ico') }}?v=1.0.0"
            alt="{{ user.display_name }}'s avatar"
            class="w-20 h-20 rounded-full border-4 border-primary-500 shadow-lg object-cover group-hover:scale-105 transition-all duration-200"
            loading="lazy"
            x-bind:class="{ 'skeleton': isLoading }"
          />
          <input
            type="file"
            id="avatar"
            name="avatar"
            class="hidden"
            accept="image/*"
            aria-label="Upload new avatar"
          />
          <svg
            class="absolute bottom-0 right-0 w-7 h-7 rounded-full bg-gradient-to-br from-primary-500 to-accent-purple flex items-center justify-center text-white text-xl shadow-lg border-2 border-bg-overlay"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <path
              d="M12 4v16m8-8H4"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </label>
        <div class="flex-1 flex flex-col gap-4">
          <label class="text-gray-300 text-sm font-semibold" for="display_name">Display Name</label>
          <input
            type="text"
            id="display_name"
            name="display_name"
            value="{{ user.display_name }}"
            class="input text-xl"
            required
            aria-describedby="display_name_error"
            x-bind:class="{ 'skeleton': isLoading }"
          />
          <span id="display_name_error" class="text-red-400 text-sm hidden">Please enter a valid display name</span>
          <label class="text-gray-300 text-sm font-semibold mt-2" for="email">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            value="{{ user.email }}"
            class="input text-xl"
            required
            aria-describedby="email_error"
            x-bind:class="{ 'skeleton': isLoading }"
          />
          <span id="email_error" class="text-red-400 text-sm hidden">Please enter a valid email</span>
        </div>
      </div>
    </div>

    <!-- Theme, Language, Timezone -->
    <div
      class="card--glass p-10"
      data-aos="fade-up"
      data-aos-delay="200"
    >
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <label class="block text-gray-300 mb-2 text-lg font-semibold" for="theme">Theme</label>
          <select id="theme" name="theme" class="input text-xl" @change="theme = $event.target.value; showToast = true; toastMsg = `Switched to ${$event.target.value} theme`">
            <option value="system" {% if settings.theme == "system" %}selected{% endif %}>System</option>
            <option value="dark" {% if settings.theme == "dark" %}selected{% endif %}>Dark</option>
            <option value="light" {% if settings.theme == "light" %}selected{% endif %}>Light</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-gray-300 mb-2 text-lg font-semibold" for="language">Language</label>
          <select id="language" name="language" class="input text-xl">
            <option value="en" {% if settings.language == "en" %}selected{% endif %}>English</option>
            <option value="es" {% if settings.language == "es" %}selected{% endif %}>Español</option>
            <option value="fr" {% if settings.language == "fr" %}selected{% endif %}>Français</option>
            <option value="de" {% if settings.language == "de" %}selected{% endif %}>Deutsch</option>
            <option value="zh" {% if settings.language == "zh" %}selected{% endif %}>中文</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-gray-300 mb-2 text-lg font-semibold" for="timezone">Timezone</label>
          <select id="timezone" name="timezone" class="input text-xl">
            <option value="UTC" {% if settings.timezone == "UTC" %}selected{% endif %}>UTC</option>
            <option value="America/New_York" {% if settings.timezone == "America/New_York" %}selected{% endif %}>New York (EST)</option>
            <option value="America/Los_Angeles" {% if settings.timezone == "America/Los_Angeles" %}selected{% endif %}>Los Angeles (PST)</option>
            <option value="Europe/London" {% if settings.timezone == "Europe/London" %}selected{% endif %}>London (GMT)</option>
            <option value="Asia/Tokyo" {% if settings.timezone == "Asia/Tokyo" %}selected{% endif %}>Tokyo (JST)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Notifications -->
    <div
      class="card--glass p-10"
      data-aos="fade-up"
      data-aos-delay="300"
    >
      <div class="flex flex-col gap-6">
        <label class="flex items-center justify-between cursor-pointer">
          <span class="text-lg text-gray-200 font-semibold">Email Notifications</span>
          <input
            type="checkbox"
            name="email_notifications"
            class="sr-only peer"
            {% if settings.email_notifications %}checked{% endif %}
            x-model="emailNotifications"
            @change="showToast = true; toastMsg = emailNotifications ? 'Email notifications enabled' : 'Email notifications disabled'"
          />
          <span
            class="w-14 h-8 flex items-center bg-bg-surface rounded-full p-1 duration-300 peer-checked:bg-primary-500 relative hover:shadow-glow"
          >
            <span
              class="dot w-6 h-6 bg-white rounded-full shadow-md transform duration-300 peer-checked:translate-x-6"
            ></span>
          </span>
        </label>
        <label class="flex items-center justify-between cursor-pointer">
          <span class="text-lg text-gray-200 font-semibold">Push Notifications</span>
          <input
            type="checkbox"
            name="push_notifications"
            class="sr-only peer"
            {% if settings.push_notifications %}checked{% endif %}
            x-model="pushNotifications"
            @change="showToast = true; toastMsg = pushNotifications ? 'Push notifications enabled' : 'Push notifications disabled'"
          />
          <span
            class="w-14 h-8 flex items-center bg-bg-surface rounded-full p-1 duration-300 peer-checked:bg-primary-500 relative hover:shadow-glow"
          >
            <span
              class="dot w-6 h-6 bg-white rounded-full shadow-md transform duration-300 peer-checked:translate-x-6"
            ></span>
          </span>
        </label>
        <label class="flex items-center justify-between cursor-pointer">
          <span class="text-lg text-gray-200 font-semibold">In-App Notifications</span>
          <input
            type="checkbox"
            name="inapp_notifications"
            class="sr-only peer"
            {% if settings.inapp_notifications %}checked{% endif %}
            x-model="inappNotifications"
            @change="showToast = true; toastMsg = inappNotifications ? 'In-app notifications enabled' : 'In-app notifications disabled'"
          />
          <span
            class="w-14 h-8 flex items-center bg-bg-surface rounded-full p-1 duration-300 peer-checked:bg-primary-500 relative hover:shadow-glow"
          >
            <span
              class="dot w-6 h-6 bg-white rounded-full shadow-md transform duration-300 peer-checked:translate-x-6"
            ></span>
          </span>
        </label>
      </div>
    </div>

    <!-- Security -->
    <div
      class="card--glass p-10"
      data-aos="fade-up"
      data-aos-delay="400"
    >
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1 flex flex-col gap-2">
          <label class="text-gray-300 text-sm font-semibold" for="password">Change Password</label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="New password"
            class="input text-xl"
            aria-describedby="password_error"
            x-bind:class="{ 'skeleton': isLoading }"
          />
          <span id="password_error" class="text-red-400 text-sm hidden">Password must be at least 8 characters</span>
        </div>
        <div class="flex-1 flex flex-col gap-2">
          <label class="text-gray-300 text-sm font-semibold">Two-Factor Authentication</label>
          <label class="flex items-center gap-3 cursor-pointer">
            <input
              type="checkbox"
              name="two_factor"
              class="sr-only peer"
              {% if security.two_factor_enabled %}checked{% endif %}
              x-model="twoFactor"
              @change="showToast = true; toastMsg = twoFactor ? '2FA enabled' : '2FA disabled'"
            />
            <span
              class="w-14 h-8 flex items-center bg-bg-surface rounded-full p-1 duration-300 peer-checked:bg-primary-500 relative hover:shadow-glow"
            >
              <span
                class="dot w-6 h-6 bg-white rounded-full shadow-md transform duration-300 peer-checked:translate-x-6"
              ></span>
            </span>
            <span class="text-gray-200">Enable 2FA</span>
          </label>
        </div>
      </div>
      <div class="mt-6">
        <div class="text-gray-300 text-sm mb-2 font-semibold">Active Sessions</div>
        <div class="flex flex-col gap-2">
          {% for session in security.active_sessions %}
          <div class="flex items-center gap-4 glass-effect rounded-lg px-4 py-2">
            <span class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></span>
            <span class="text-gray-200 text-sm">{{ session.ip }} — {{ session.browser }} — {{ session.location }} — {{ session.last_active }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Experimental Features & Accessibility -->
    <div
      class="card--glass p-10"
      data-aos="fade-up"
      data-aos-delay="500"
    >
      <label class="flex items-center justify-between cursor-pointer mb-6">
        <span class="text-lg text-gray-200 font-semibold">Enable Experimental Features</span>
        <input
          type="checkbox"
          name="experimental_features"
          class="sr-only peer"
          {% if settings.experimental_features %}checked{% endif %}
          x-model="experimentalFeatures"
          @change="showToast = true; toastMsg = experimentalFeatures ? 'Experimental features enabled' : 'Experimental features disabled'"
        />
        <span
          class="w-14 h-8 flex items-center bg-bg-surface rounded-full p-1 duration-300 peer-checked:bg-primary-500 relative hover:shadow-glow"
        >
          <span
            class="dot w-6 h-6 bg-white rounded-full shadow-md transform duration-300 peer-checked:translate-x-6"
          ></span>
        </span>
      </label>
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <label class="block text-gray-300 mb-2 text-lg font-semibold" for="font_size">Font Size</label>
          <select id="font_size" name="font_size" class="input text-xl">
            <option value="normal" {% if settings.font_size == "normal" %}selected{% endif %}>Normal</option>
            <option value="large" {% if settings.font_size == "large" %}selected{% endif %}>Large</option>
            <option value="xlarge" {% if settings.font_size == "xlarge" %}selected{% endif %}>Extra Large</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-gray-300 mb-2 text-lg font-semibold" for="contrast">Contrast</label>
          <select id="contrast" name="contrast" class="input text-xl">
            <option value="normal" {% if settings.contrast == "normal" %}selected{% endif %}>Normal</option>
            <option value="high" {% if settings.contrast == "high" %}selected{% endif %}>High Contrast</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-gray-300 mb-2 text-lg font-semibold" for="motion">Motion</label>
          <select id="motion" name="motion" class="input text-xl">
            <option value="normal" {% if settings.motion == "normal" %}selected{% endif %}>Normal</option>
            <option value="reduced" {% if settings.motion == "reduced" %}selected{% endif %}>Reduced Motion</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Account Actions -->
    <div
      class="card--glass p-10"
      data-aos="fade-up"
      data-aos-delay="600"
    >
      <div class="flex flex-col md:flex-row gap-6 items-center">
        <button
          type="button"
          class="btn-primary flex-1 text-lg"
          x-bind:disabled="isLoading"
          @click="showToast = true; toastMsg = 'Exporting data...'"
        >
          Export My Data
        </button>
        <button
          type="button"
          class="btn flex-1 bg-gradient-to-r from-red-500 to-pink-500 text-white hover:bg-red-600 text-lg"
          x-bind:disabled="isLoading"
          @click="if(confirm('Are you sure you want to delete your account? This action cannot be undone.')) { showToast = true; toastMsg = 'Account deletion requested' }"
        >
          Delete My Account
        </button>
      </div>
    </div>

    <button
      type="submit"
      class="btn-primary w-full text-lg"
      x-bind:disabled="isLoading"
      x-bind:class="{ 'skeleton': isLoading }"
    >
      <span x-show="!isLoading">Save Changes</span>
      <span x-show="isLoading" class="flex items-center justify-center">
        <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
      </span>
    </button>

    <div
      x-show="showSuccess"
      class="mt-6 glass-effect p-4 rounded-lg text-green-400 font-bold text-center"
      aria-live="polite"
      data-aos="fade-in"
      data-aos-delay="200"
    >
      Settings saved successfully!
    </div>
  </form>
</div>
{% endblock %}
{% block scripts %}
  <script defer src="{{ url_for('static', filename='js/settings.min.js') }}?v=1.0.0"></script>
  <script nonce="{{ g.nonce }}">
    document.addEventListener('DOMContentLoaded', () => {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('animate-fadeIn');
          }
        });
      }, { threshold: 0.1 });
      document.querySelectorAll('.card--glass').forEach(card => observer.observe(card));
    });
  </script>
{% endblock %}
