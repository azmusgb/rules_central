<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Interactive hierarchy viewer for visualizing and navigating complex rule systems" />
  <title>Hierarchy Viewer - Rules Central</title>

  <!-- ===================================================================
       SECTION 1: RESOURCE PRELOADS AND CRITICAL CSS
       =================================================================== -->
  
  <!-- Preload critical resources -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" as="style">
  <link rel="preload" href="{{ url_for('static', filename='css/styles.css') }}" as="style">

  <!-- Tailwind CSS with plugins -->
  <script defer src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>

  <!-- ===================================================================
       SECTION 2: STYLESHEETS
       =================================================================== -->
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
  
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
  
  <!-- Custom styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  
  <!-- Shoelace theme -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0/dist/themes/dark.css">

  <!-- ===================================================================
       SECTION 3: FAVICON AND METADATA
       =================================================================== -->
  
  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><circle cx=\"60\" cy=\"60\" r=\"50\" fill=\"%237c3aed\"/></svg>">

  <!-- ===================================================================
       SECTION 4: INLINE STYLES
       =================================================================== -->
  
  <style>
    /* Color variables */
    :root { 
      --sl-color-primary-500: #7c3aed; 
      --sl-color-primary-600: #4c1d95; 
      --transition-speed: 150ms; 
    }
    
    /* Light theme overrides */
    [data-theme="light"] { 
      --sl-color-primary-500: #a78bfa; 
      --sl-color-primary-600: #7c3aed; 
    }
    
    /* Reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: .01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: .01ms !important;
        scroll-behavior: auto !important;
      }
    }
    
    /* Focus styles */
    :focus-visible {
      outline: 2px solid var(--sl-color-primary-500);
      outline-offset: 2px;
    }
    
    /* Print styles */
    @media print {
      .no-print {
        display: none !important;
      }
    }
  </style>
</head>

<!-- ===================================================================
     SECTION 5: MAIN BODY STRUCTURE
     =================================================================== -->
<body class="bg-dark-900 text-slate-200 font-sans antialiased min-h-screen flex flex-col"
      data-root-name="{{ root_name }}"
      data-diagram-name="{{ diagram_name }}">

  <!-- Skip to content link for accessibility -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4
     focus:bg-dark-800 focus:px-4 focus:py-2 focus:rounded-lg focus:z-50 focus:ring-2 focus:ring-primary-500">
    Skip to main content
  </a>

  <!-- ===================================================================
       SECTION 6: MAIN NAVIGATION
       =================================================================== -->
  <nav class="bg-panel shadow-lg sticky top-0 z-40 print:hidden" aria-label="Main navigation">
    <div class="container mx-auto flex items-center justify-between px-4 py-3">
      <!-- Logo/branding -->
      <div class="font-bold text-lg flex items-center">
        <i class="fas fa-project-diagram mr-2 text-primary-400" aria-hidden="true"></i>
        <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-primary-400">
          Hierarchy Viewer
        </span>
      </div>
      
      <!-- Navigation controls -->
      <div class="flex space-x-2">
        <button id="theme-toggle"
                class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg transition-colors duration-[var(--transition-speed)]"
                aria-label="Toggle light/dark theme">
          <i class="fas fa-adjust" aria-hidden="true"></i>
        </button>
        
        <button id="profile-toggle"
                class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg transition-colors duration-[var(--transition-speed)]"
                aria-label="Profile settings">
          <i class="fas fa-user" aria-hidden="true"></i>
        </button>
        
        <button id="shortcut-toggle"
                class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg transition-colors duration-[var(--transition-speed)]"
                aria-label="Help & shortcuts">
          <i class="fas fa-question" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- ===================================================================
       SECTION 7: MAIN CONTENT WRAPPER
       =================================================================== -->
  <div class="main-gradient-border flex-grow">
    <div class="main-content-inner">
      <main id="main-content" class="container mx-auto px-4 sm:px-6 py-6">
        <!-- Page header -->
        <header class="mb-8">
          <h1 class="text-2xl font-bold text-white">
            Visualize Your Rules
          </h1>
          <p class="text-slate-400 mt-2">Navigate through the rules for better clarity.</p>
        </header>

        <!-- ===================================================================
             SECTION 8: MAIN GRID LAYOUT
             =================================================================== -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

          <!-- =================================================================
               SECTION 9: LEFT/MAIN COLUMN (HIERARCHY VIEW)
               ================================================================= -->
          <div class="lg:col-span-2 space-y-6">

            <!-- Search and filter panel -->
            <section class="panel panel--glass" aria-labelledby="search-panel-heading">
              <h2 id="search-panel-heading" class="sr-only">Search and filter rules</h2>

              <form id="search-filter-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <!-- Search box -->
                <div class="relative">
                  <label for="hierarchy-search" class="block text-sm font-semibold text-slate-400 mb-1">
                    Search rules and attributes
                  </label>
                  <div class="relative flex items-center">
                    <i class="fas fa-search absolute left-3 text-slate-500" aria-hidden="true"></i>
                    <input id="hierarchy-search" type="search"
                           class="w-full pl-10 pr-24 py-2 bg-dark-700 border border-slate-700 rounded-lg
                                  focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                           placeholder="Search by name, GUID, function…" spellcheck="false" autocomplete="off"
                           aria-label="Search rules" aria-autocomplete="list" aria-controls="search-suggestions">
                    <div class="absolute right-2 flex items-center space-x-1">
                      <button type="button" id="prev-match" aria-label="Previous match"
                              class="p-1 text-slate-500 hover:text-white disabled:opacity-50" disabled>
                        <i class="fas fa-chevron-up"></i>
                      </button>
                      <span id="match-index" class="text-xs text-slate-500 hidden" aria-live="polite">0/0</span>
                      <button type="button" id="next-match" aria-label="Next match"
                              class="p-1 text-slate-500 hover:text-white disabled:opacity-50" disabled>
                        <i class="fas fa-chevron-down"></i>
                      </button>
                      <button type="button" id="clear-search" aria-label="Clear search"
                              class="p-1 text-slate-500 hover:text-white hidden">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <ul id="search-suggestions"
                      class="hidden absolute z-50 w-full mt-1 bg-dark-800 border border-slate-700 rounded-lg
                             shadow-lg max-h-60 overflow-auto" role="listbox"></ul>
                </div>

                <!-- Node type filter -->
                <div>
                  <label for="node-type-filter" class="block text-sm font-semibold text-slate-400 mb-1">Node Type</label>
                  <select id="node-type-filter"
                          class="w-full bg-dark-700 border border-slate-700 rounded-lg px-4 py-2
                                 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <option value="">All Nodes</option>
                    <option value="regular">Regular Nodes</option>
                    <option value="action">Action Nodes</option>
                  </select>
                </div>

                <!-- Attribute filter -->
                <div>
                  <label for="attribute-filter" class="block text-sm font-semibold text-slate-400 mb-1">Search Field</label>
                  <select id="attribute-filter"
                          class="w-full bg-dark-700 border border-slate-700 rounded-lg px-4 py-2
                                 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <option value="">Any Field</option>
                    <option value="RuleName">Rule Name</option>
                    <option value="RuleGUID">Rule GUID</option>
                    <option value="FunctionName">Function</option>
                    <option value="Attributes">Attributes</option>
                    <option value="Container">Container</option>
                    <option value="RootName">Root Name</option>
                  </select>
                </div>
              </form>

              <!-- Quick filters -->
              <div class="flex flex-wrap gap-3 mt-4">
                <button type="button" class="btn" data-filter='{"nodeType":"action"}'>
                  <i class="fas fa-bolt mr-1"></i> Action Nodes
                </button>
                <button type="button" class="btn" data-filter='{"level":"3"}'>
                  <i class="fas fa-layer-group mr-1"></i> Deep Nodes&nbsp;(3+)
                </button>
                <button type="button" class="btn" data-filter='{"attribute":"FunctionName"}'>
                  <i class="fas fa-code mr-1"></i> Functions Only
                </button>
                <button type="button" class="btn" data-filter='{"attribute":"RuleGUID"}'>
                  <i class="fas fa-fingerprint mr-1"></i> GUIDs Only
                </button>
              </div>

              <!-- Form action buttons -->
              <div class="flex flex-wrap gap-3 mt-4">
                <button type="button" id="search-btn"
                        class="btn bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white">
                  <i class="fas fa-search mr-1"></i> Search Rules
                </button>
                <button type="button" id="filter-reset"
                        class="btn bg-dark-700 hover:bg-dark-600 border border-slate-700 text-white">
                  <i class="fas fa-undo mr-1"></i> Reset All
                </button>
                <button type="button" id="export-btn" aria-haspopup="dialog"
                        class="btn bg-dark-700 hover:bg-dark-600 border border-slate-700 text-white">
                  <i class="fas fa-download mr-1"></i> Export
                </button>
              </div>
            </section>

            <!-- Hierarchy tree panel -->
            <section class="panel panel--glass" aria-labelledby="hierarchy-heading">
              <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h2 id="hierarchy-heading" class="flex items-center gap-2 font-semibold">
                  <i class="fas fa-diagram-project text-primary-400"></i>
                  <span>Hierarchy Tree</span>
                </h2>
                <div id="node-count"
                     class="text-xs text-slate-400 bg-dark-700 px-2 py-1 rounded-full"
                     aria-live="polite">Loading nodes…</div>
              </div>
              
              <!-- Tree container -->
              <div id="diagram-outline"
                   class="p-4 h-[calc(100vh-400px)] overflow-auto"
                   tabindex="0" aria-label="Rule hierarchy" role="tree">
                <!-- Loading spinner -->
                <div id="spinner" class="flex justify-center items-center p-8">
                  <div class="animate-spin rounded-full h-10 w-10 border-2 border-primary-500 border-t-transparent"
                       aria-label="Loading"></div>
                </div>
                
                <!-- Loading skeleton -->
                <div id="loading-skeleton" class="space-y-2" aria-hidden="true">
                  <div class="bg-dark-700 rounded h-8 mb-2 w-full animate-pulse"></div>
                  <div class="bg-dark-700 rounded h-8 mb-2 w-5/6 ml-4 animate-pulse"></div>
                  <div class="bg-dark-700 rounded h-8 mb-2 w-3/4 ml-8 animate-pulse"></div>
                  <div class="bg-dark-700 rounded h-8 mb-2 w-5/6 ml-4 animate-pulse"></div>
                  <div class="bg-dark-700 rounded h-8 mb-2 w-full animate-pulse"></div>
                </div>
              </div>
            </section>
          </div> <!-- /main column -->

          <!-- =================================================================
               SECTION 10: RIGHT SIDEBAR (DETAILS VIEW)
               ================================================================= -->
          <div class="space-y-6">

            <!-- Search results sidebar -->
            <section class="panel panel--glass hidden lg:block"
                     id="search-sidebar" aria-labelledby="search-results-heading">
              <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h2 id="search-results-heading" class="flex items-center gap-2 font-semibold">
                  <i class="fas fa-search text-primary-400"></i> <span>Search Results</span>
                </h2>
                <button id="close-search-sidebar"
                        class="text-slate-400 hover:text-white transition-colors duration-[var(--transition-speed)]"
                        aria-label="Close Search Results Sidebar">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="p-4 max-h-[300px] overflow-auto">
                <div id="search-results-empty" class="text-center text-slate-500 py-4">
                  <i class="fas fa-search mb-2"></i>
                  <p>No search results yet</p>
                </div>
                <ul id="search-results-list" class="hidden space-y-2"></ul>
              </div>
            </section>

            <!-- Node details panel -->
            <section class="panel panel--glass" aria-labelledby="node-details-heading">
              <div class="flex border-b border-slate-700" role="tablist" aria-labelledby="node-details-heading">
                <button id="tab-attributes"
                        class="px-4 py-3 font-medium border-b-2 border-primary-500 text-primary-400"
                        data-tab="attributes" role="tab" aria-selected="true" aria-controls="attributes-tab">
                  <i class="fas fa-tags mr-2"></i> Attributes
                </button>
                <button id="tab-actions"
                        class="px-4 py-3 font-medium text-slate-400 hover:text-white transition-colors duration-[var(--transition-speed)]"
                        data-tab="actions" role="tab" aria-selected="false" aria-controls="actions-tab" tabindex="-1">
                  <i class="fas fa-bolt mr-2"></i> Actions
                </button>
                <button id="tab-json"
                        class="px-4 py-3 font-medium text-slate-400 hover:text-white transition-colors duration-[var(--transition-speed)]"
                        data-tab="json" role="tab" aria-selected="false" aria-controls="json-tab" tabindex="-1">
                  <i class="fas fa-code mr-2"></i> JSON
                </button>
                <button id="tab-relations"
                        class="px-4 py-3 font-medium text-slate-400 hover:text-white transition-colors duration-[var(--transition-speed)]"
                        data-tab="relations" role="tab" aria-selected="false" aria-controls="relations-tab" tabindex="-1">
                  <i class="fas fa-project-diagram mr-2"></i> Relations
                </button>
              </div>

              <!-- Attributes tab content -->
              <div id="attributes-tab" class="p-4" role="tabpanel" aria-labelledby="tab-attributes">
                <div class="mb-4 flex justify-between items-center">
                  <h3 class="font-semibold">Node Attributes</h3>
                  <button id="copy-attributes"
                          class="text-sm text-slate-400 hover:text-white"
                          aria-label="Copy attributes to clipboard">
                    <i class="fas fa-copy mr-1"></i> Copy
                  </button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                  <table class="w-full">
                    <thead class="bg-dark-700">
                      <tr>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-slate-400">Attribute</th>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-slate-400">Value</th>
                      </tr>
                    </thead>
                    <tbody id="attributes-table-body"></tbody>
                  </table>
                </div>
              </div>

              <!-- Actions tab content -->
              <div id="actions-tab" class="hidden p-4" role="tabpanel" aria-labelledby="tab-actions">
                <div class="mb-4 flex justify-between items-center">
                  <h3 class="font-semibold">Available Actions</h3>
                  <button id="copy-actions"
                          class="text-sm text-slate-400 hover:text-white"
                          aria-label="Copy actions to clipboard">
                    <i class="fas fa-copy mr-1"></i> Copy
                  </button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                  <table class="w-full">
                    <thead class="bg-dark-700">
                      <tr>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-slate-400">Action</th>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-slate-400">Details</th>
                      </tr>
                    </thead>
                    <tbody id="actions-table-body"></tbody>
                  </table>
                </div>
              </div>

              <!-- JSON tab content -->
              <div id="json-tab" class="hidden p-4" role="tabpanel" aria-labelledby="tab-json">
                <div class="mb-4 flex justify-between items-center">
                  <h3 class="font-semibold">Raw JSON Data</h3>
                  <button id="copy-json"
                          class="text-sm text-slate-400 hover:text-white"
                          aria-label="Copy JSON to clipboard">
                    <i class="fas fa-copy mr-1"></i> Copy JSON
                  </button>
                </div>
                <pre id="raw-json-block"
                     class="hidden bg-dark-700 p-4 rounded-lg overflow-auto max-h-64 text-sm"></pre>
                <div id="json-skeleton" class="space-y-2">
                  <div class="bg-dark-700 rounded h-5 w-full animate-pulse"></div>
                  <div class="bg-dark-700 rounded h-5 w-11/12 animate-pulse"></div>
                  <div class="bg-dark-700 rounded h-5 w-10/12 ml-4 animate-pulse"></div>
                  <div class="bg-dark-700 rounded h-5 w-9/12 ml-8 animate-pulse"></div>
                  <div class="bg-dark-700 rounded h-5 w-10/12 ml-4 animate-pulse"></div>
                  <div class="bg-dark-700 rounded h-5 w-11/12 animate-pulse"></div>
                </div>
              </div>

              <!-- Relations tab content -->
              <div id="relations-tab" class="hidden p-4" role="tabpanel" aria-labelledby="tab-relations">
                <div class="mb-4 flex justify-between items-center">
                  <h3 class="font-semibold">Node Relations</h3>
                  <button id="copy-relations"
                          class="text-sm text-slate-400 hover:text-white"
                          aria-label="Copy relations to clipboard">
                    <i class="fas fa-copy mr-1"></i> Copy
                  </button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                  <table class="w-full">
                    <thead class="bg-dark-700">
                      <tr>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-slate-400">Relation Type</th>
                        <th class="px-4 py-2 text-left text-sm font-semibold text-slate-400">Target Node</th>
                      </tr>
                    </thead>
                    <tbody id="relations-table-body"></tbody>
                  </table>
                </div>
              </div>
            </section>
          </div> <!-- /sidebar -->
        </div> <!-- /grid -->
      </main>
    </div>
  </div>

  <!-- ===================================================================
       SECTION 11: MOBILE CONTROLS
       =================================================================== -->
  <button id="mobile-search-toggle"
          class="lg:hidden fixed bottom-6 right-6 bg-primary-500 text-white w-12 h-12 rounded-full
                 flex items-center justify-center shadow-xl z-50 hover:scale-110 transition-transform
                 duration-[var(--transition-speed)] focus:outline-none focus:ring-2 focus:ring-white"
          aria-label="Open Search Sidebar" aria-expanded="false" aria-controls="search-sidebar">
    <i class="fas fa-search"></i>
  </button>

  <!-- ===================================================================
       SECTION 12: MODAL DIALOGS
       =================================================================== -->
  
  <!-- Export modal -->
  <div id="export-modal"
       class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-dark-800 w-full max-w-md rounded-lg shadow-lg p-6 space-y-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Export Hierarchy</h3>
        <button id="close-export-modal" class="text-slate-400 hover:text-white" aria-label="Close export dialog">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <button id="export-png" class="btn w-full"><i class="fas fa-image mr-2"></i> Download PNG</button>
      <button id="export-pdf" class="btn w-full"><i class="fas fa-file-pdf mr-2"></i> Download PDF</button>
    </div>
  </div>

  <!-- Keyboard shortcuts modal -->
  <div id="shortcut-modal"
       class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-dark-800 w-full max-w-lg rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Keyboard Shortcuts</h3>
        <button id="close-shortcut-modal" class="text-slate-400 hover:text-white" aria-label="Close shortcuts dialog">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <table class="w-full text-sm">
        <tbody>
          <tr><td class="py-1 pr-4 text-slate-400">/ or Ctrl&nbsp;+&nbsp;F</td><td>Focus search box</td></tr>
          <tr><td class="py-1 pr-4 text-slate-400">↑ / ↓</td><td>Navigate suggestions / matches</td></tr>
          <tr><td class="py-1 pr-4 text-slate-400">Enter</td><td>Select suggestion</td></tr>
          <tr><td class="py-1 pr-4 text-slate-400">Esc</td><td>Dismiss suggestions</td></tr>
          <tr><td class="py-1 pr-4 text-slate-400">← / →</td><td>Expand / collapse node</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profile-modal"
       class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-dark-800 w-full max-w-sm rounded-lg shadow-lg p-6 space-y-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Profile</h3>
        <button id="close-profile-modal" class="text-slate-400 hover:text-white" aria-label="Close profile dialog">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="text-slate-400 text-sm">User-settings panel coming soon…</p>
    </div>
  </div>

  <!-- ===================================================================
       SECTION 13: CONTEXT MENUS AND UTILITY ELEMENTS
       =================================================================== -->
  
  <!-- Context menu container -->
  <ul id="node-context-menu"
      class="hidden fixed bg-dark-800 border border-slate-700 rounded shadow-lg text-sm z-50"
      role="menu"></ul>

  <!-- Node hover preview -->
  <div id="node-hover-preview"
       class="hidden fixed pointer-events-none bg-dark-700 text-slate-200 text-sm px-2 py-1 rounded
              shadow-lg border border-slate-600 z-50"></div>

  <!-- Toast notifications -->
  <sl-alert id="toast" variant="primary" duration="3000" closable
            class="hidden fixed bottom-4 right-4 z-50 max-w-xs">
    <sl-icon slot="icon" name="info-circle"></sl-icon>
    <span id="toast-message">Notification message</span>
  </sl-alert>

  <!-- ===================================================================
       SECTION 14: JAVASCRIPT DEPENDENCIES
       =================================================================== -->
  
  <!-- JS libraries -->
  <script defer src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0/dist/shoelace.js"></script>
  
  <!-- Application scripts -->
  <!-- profile.js is imported by hierarchy_viewer.js -->
  <script type="module" src="{{ url_for('static', filename='js/hierarchy_viewer.js') }}"></script>

  <!-- ===================================================================
       SECTION 15: INLINE JAVASCRIPT
       =================================================================== -->
  
  <script>
    // Initialize when DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
      const html = document.documentElement;
      
      // DOM element references
      const themeToggle = document.getElementById('theme-toggle');
      const profileToggle = document.getElementById('profile-toggle');
      const shortcutToggle = document.getElementById('shortcut-toggle');
      const profileModal = document.getElementById('profile-modal');
      const shortcutModal = document.getElementById('shortcut-modal');
      const exportModal = document.getElementById('export-modal');

      // Theme management
      const updateThemeIcon = (theme) => {
        const icon = themeToggle?.querySelector('i');
        if (!icon) return;
        
        // Clear existing classes
        icon.classList.remove('fa-adjust', 'fa-sun');
        
        // Add appropriate class based on theme
        icon.classList.add(theme === 'dark' ? 'fa-adjust' : 'fa-sun');
      };
      
      // Initialize theme from localStorage or default to dark
      const savedTheme = localStorage.getItem('theme') || 'dark';
      html.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
      
      // Theme toggle handler
      themeToggle?.addEventListener('click', () => {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        // Update theme
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      });

      // Modal management functions
      const openModal = (modal) => modal?.classList.remove('hidden');
      const closeModal = (modal) => modal?.classList.add('hidden');
      
      // Modal event handlers
      profileToggle?.addEventListener('click', () => openModal(profileModal));
      shortcutToggle?.addEventListener('click', () => openModal(shortcutModal));
      
      document.getElementById('close-profile-modal')?.addEventListener('click', () => closeModal(profileModal));
      document.getElementById('close-shortcut-modal')?.addEventListener('click', () => closeModal(shortcutModal));
      document.getElementById('close-export-modal')?.addEventListener('click', () => closeModal(exportModal));

      // Toast notification helper
      window.showToast = (message, variant = 'primary', duration = 3000) => {
        const toastElement = document.getElementById('toast');
        const messageElement = document.getElementById('toast-message');
        
        if (!toastElement || !messageElement) return;
        
        // Update toast content and settings
        messageElement.textContent = message;
        toastElement.variant = variant;
        toastElement.duration = duration;
        
        // Show toast
        toastElement.classList.remove('hidden');
        toastElement.toast();
      };
    });

    // Prevent flash of wrong theme (FOUC)
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const systemTheme = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
      const initialTheme = savedTheme || systemTheme;
      
      // Set initial theme
      document.documentElement.setAttribute('data-theme', initialTheme);
      
      // Set color-scheme meta tag
      const meta = document.createElement('meta');
      meta.name = 'color-scheme';
      meta.content = initialTheme;
      document.head.appendChild(meta);
    })();
  </script>
</body>
</html>