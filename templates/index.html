{% extends "base.html" %}

{% block title %}Dashboard | Rules Central{% endblock title %}
{% block description %}Centralized rules management system dashboard.{% endblock description %}

{% set _updated = (
    last_updated
    if (last_updated is defined and last_updated)
    else (
        stats.generated_at
        if (stats is defined and stats and 'generated_at' in stats)
        else None
    )
) %}

{% block content %}

{# ============================================================
   HERO (Index / Dashboard landing)
   ============================================================ #}
<section id="rc-hero" class="rc-hero rc-hero--dashboard" role="region" aria-labelledby="rc-hero-title">
  <div class="rc-hero-bg" aria-hidden="true"></div>
  <div class="rc-hero-glow" aria-hidden="true"></div>

  <div class="rc-hero-inner">
    <div class="rc-hero-badge-wrap">
      <span class="rc-hero-badge">
        <span class="rc-hero-badge-dot" aria-hidden="true"></span>
        <span class="rc-hero-badge-text">Rules Management Dashboard</span>
      </span>
    </div>

    <h1 id="rc-hero-title" class="rc-hero-title">Rules Central</h1>

    <p class="rc-hero-subtitle">
      Manage your rules effortlessly with real-time insights, key metrics, and streamlined workflows.
    </p>

    <div class="rc-hero-actions">
      <a href="{{ url_for('routes.config_page') }}" class="rc-btn rc-btn-primary" aria-label="Create new rule">New Rule</a>
      <a href="{{ url_for('main.catalog') }}" class="rc-btn rc-btn-outline" aria-label="View rule catalog">View Catalog</a>
      <a href="#quick-actions" class="rc-btn rc-btn-text">Quick Tour</a>
    </div>
  </div>
</section>


{# ============================================================
   METRICS
   ============================================================ #}
<section id="metrics" class="wrapper rc-container rc-section rc-metrics">
  <div class="rc-section-head">
    <h2 class="rc-section-title">
      <span aria-hidden="true" class="rc-section-ico">üìà</span>
      Key Metrics
    </h2>
    <div class="rc-section-sub">
      <span aria-hidden="true">üïí</span>
      Last updated:
      <span class="font-medium">
        {% if _updated %}
          {{ _updated.strftime('%b %d, %Y %I:%M %p') if _updated.__class__.__name__ in ['datetime','date'] else _updated }}
        {% else %}‚Äî{% endif %}
      </span>
      <button id="rc-metrics-refresh" type="button" class="rc-mini-btn" aria-label="Refresh metrics">Refresh</button>
    </div>
  </div>

  {# Metric card macro -------------------------------------- #}
  {% macro mcard(label, value, accent='', link=None, svg=None, trend=None) %}
    <div class="rc-card rc-metric {{ accent }} {% if link %}rc-card-link{% endif %}">
      {% if link %}
        <a href="{{ link }}" class="absolute inset-0 z-10 sr-only-focusable" aria-label="{{ label }}"></a>
      {% endif %}
      <div class="rc-metric-body">
        <div class="rc-metric-top">
          <div>
            <p class="rc-metric-label">{{ label }}</p>
            <p class="rc-metric-value">{{ value|default(0) }}</p>
          </div>
          <div class="rc-metric-icon">
            {% if svg %}{{ svg|safe }}{% else %}<span aria-hidden="true">‚Ä¢</span>{% endif %}
          </div>
        </div>
        {% if trend is not none %}
          {% if trend is mapping %}
            {% set pct = trend.get('pct', 0) %}
            {% set up = trend.get('is_up', pct >= 0) %}
            <p class="rc-metric-trend {{ 'rc-metric-up' if up else 'rc-metric-down' }}">{{ pct|round(1) }}% vs previous</p>
          {% else %}
            <p class="rc-metric-trend">{{ trend }}</p>
          {% endif %}
        {% else %}
          <p class="rc-metric-trend rc-metric-trend-empty" aria-hidden="true">&nbsp;</p>
        {% endif %}
      </div>
    </div>
  {% endmacro %}

  {# Small SVG icon snippets -------------------------------- #}
  {% set svg_rules %}
    <svg viewBox="0 0 24 24" class="rc-ico" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="3" width="7" height="7" rx="1"/>
      <rect x="14" y="14" width="7" height="7" rx="1"/>
      <rect x="3" y="14" width="7" height="7" rx="1"/>
    </svg>
  {% endset %}
  {% set svg_cal %}
    <svg viewBox="0 0 24 24" class="rc-ico" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="4" width="18" height="18" rx="2"/>
      <line x1="16" y1="2" x2="16" y2="6"/>
      <line x1="8"  y1="2" x2="8"  y2="6"/>
      <line x1="3"  y1="10" x2="21" y2="10"/>
      <path d="M8 14h2v2H8zM12 14h2v2h-2zM16 14h2v2h-2z"/>
    </svg>
  {% endset %}

  <div class="rc-metrics-grid">
    {{ mcard('Total Rules',
             stats.total_rules if stats and 'total_rules' in stats else 0,
             'rc-accent-primary',
             url_for('main.catalog'),
             svg_rules) }}

    {{ mcard('Changed ¬∑ 7 Days',
             stats.changed_7d if stats and 'changed_7d' in stats else 0,
             'rc-accent-amber',
             url_for('main.catalog') ~ '?range=7d',
             svg_cal,
             stats.trend_7d if stats and 'trend_7d' in stats else None) }}

    {{ mcard('Changed ¬∑ 30 Days',
             stats.changed_30d if stats and 'changed_30d' in stats else 0,
             'rc-accent-rose',
             url_for('main.catalog') ~ '?range=30d',
             svg_cal,
             stats.trend_30d if stats and 'trend_30d' in stats else None) }}

    {{ mcard('Changed ¬∑ 90 Days',
             stats.changed_90d if stats and 'changed_90d' in stats else 0,
             'rc-accent-indigo',
             url_for('main.catalog') ~ '?range=90d',
             svg_cal,
             stats.trend_90d if stats and 'trend_90d' in stats else None) }}
  </div>
</section>


{# ============================================================
   TREND + RECENT ACTIVITY
   ============================================================ #}
<section class="wrapper rc-container rc-section rc-trend-activity">
  <div class="rc-trend-activity-grid">
    <!-- Trend -->
    <section aria-labelledby="trend-heading" class="rc-trend-col rc-card rc-surface-1">
      <div class="rc-section-head rc-section-head-split">
        <h2 id="trend-heading" class="rc-section-title">
          <span aria-hidden="true" class="rc-section-ico">üìä</span>
          Rule Change Trends
        </h2>
        <div class="rc-toggle-pill" role="group" aria-label="Select time range for trend chart">
          <button data-range="30d" class="rc-toggle active" type="button">30D</button>
          <button data-range="90d" class="rc-toggle" type="button">90D</button>
          <button data-range="1y"  class="rc-toggle" type="button">1Y</button>
        </div>
      </div>
      <div class="rc-chart-wrap">
        <canvas id="rulesTrendChart" aria-label="Rule change trends chart" role="img" height="280"></canvas>
      </div>
      <div class="rc-chart-foot">
        <button class="rc-chart-foot-btn" data-action="export">Export</button>
        <button class="rc-chart-foot-btn" data-action="fullscreen">Fullscreen</button>
      </div>
    </section>

    <!-- Recent Activity -->
    <section aria-labelledby="activity-heading" class="rc-activity-col rc-card rc-surface-1">
      <h2 id="activity-heading" class="rc-section-title rc-section-title-sub">
        <span aria-hidden="true" class="rc-section-ico">üïë</span>
        Recent Activity
      </h2>

      {% macro activity_item(act) %}
        {# act: {'action':str,'user':str,'time':str,'rule':str?, 'type':str?} #}
        {% set icon = 'üîß' %}
        {% if act.type == 'create' %}{% set icon = '‚ûï' %}
        {% elif act.type == 'update' %}{% set icon = '‚úèÔ∏è' %}
        {% elif act.type == 'delete' %}{% set icon = 'üóë' %}
        {% elif act.type == 'import' %}{% set icon = 'üì•' %}
        {% elif act.type == 'approve' %}{% set icon = '‚úÖ' %}
        {% endif %}
        <div class="rc-activity-item">
          <span class="rc-activity-ico" aria-hidden="true">{{ icon }}</span>
          <div class="rc-activity-body">
            <p class="rc-activity-text">
              {{ act.action }}
              {% if act.rule %}
                <a href="{{ url_for('main.catalog') }}" class="rc-activity-link">"{{ act.rule }}"</a>
              {% endif %}
            </p>
            <p class="rc-activity-meta">
              <span>{{ act.user }}</span>
              <span class="rc-activity-dot" aria-hidden="true">‚Ä¢</span>
              <span>{{ act.time }}</span>
            </p>
          </div>
        </div>
      {% endmacro %}

      <div class="rc-activity-list rc-scroll">
        {% if activity and activity|length %}
          {% for a in activity %}
            {{ activity_item(a) }}
          {% endfor %}
        {% else %}
          <p class="rc-activity-empty">No recent activity.</p>
        {% endif %}
      </div>

      <div class="rc-activity-more">
        <a href="{{ url_for('routes.activity') }}" class="rc-activity-more-link">View all activity ‚Ä∫</a>
      </div>
    </section>
  </div>
</section>


{# ============================================================
   QUICK ACTIONS
   ============================================================ #}
<section id="quick-actions" aria-labelledby="actions-heading" class="wrapper rc-container rc-section rc-quick-actions">
  <h2 id="actions-heading" class="rc-section-title">
    <span aria-hidden="true" class="rc-section-ico">‚ö°</span>
    Quick Actions & Tools
  </h2>

  {% macro qa(label, desc, url, icon='‚Ä∫', accent='') %}
    <a href="{{ url }}"
       class="rc-card rc-qa-card {{ accent }}"
       aria-label="{{ label }}">
      <div class="rc-qa-card-inner">
        <span class="rc-qa-ico" aria-hidden="true">{{ icon }}</span>
        <span class="rc-qa-textwrap">
          <span class="rc-qa-text">{{ label }}</span>
          <span class="rc-qa-desc">{{ desc }}</span>
        </span>
        <span class="rc-qa-arrow" aria-hidden="true">‚Ä∫</span>
      </div>
    </a>
  {% endmacro %}

  <div class="rc-qa-grid">
    {{ qa('Import Rules','Bulk import from CSV or Excel', url_for('upload.upload_file'),'üì•','rc-qa-import') }}
    {{ qa('Generate Diagram','Visualize rule relationships', url_for('diagrams.diagram_converter'),'üß©','rc-qa-diagram') }}
    {{ qa('Documentation','Guides & API references', url_for('routes.full_help'),'üìñ','rc-qa-docs') }}
  </div>
</section>

{% endblock content %}



{# ============================================================
   PAGE STYLES (Fallback / Scoped)
   ============================================================ #}
{% block styles %}
<style>
/* ---------- Hero (Dashboard) Fallback Styles ---------- */
.rc-hero{
  position:relative;
  isolation:isolate;
  text-align:center;
  padding-top:var(--rc-hero-pad-top,6rem);
  padding-bottom:var(--rc-hero-pad-btm,4rem);
}
.rc-hero-bg{
  position:absolute;
  inset:0;
  z-index:-2;
  background:var(--rc-hero-bg,linear-gradient(180deg,rgba(255,255,255,.0)0%,rgba(0,0,0,.35)100%));
}
html.dark .rc-hero-bg{
  background:linear-gradient(180deg,rgba(255,255,255,.05)0%,rgba(0,0,0,.8)100%);
}
.rc-hero-glow{
  position:absolute;
  inset:0;
  z-index:-1;
  pointer-events:none;
  background:radial-gradient(circle at 50% 20%,rgba(244,63,94,.35),transparent 60%);
}
.rc-hero-inner{
  max-width:60rem;
  margin-inline:auto;
  padding-inline:clamp(1rem,3vw,2rem);
  display:grid;
  gap:1.25rem;
  justify-items:center;
}
.rc-hero-badge{
  display:inline-flex;
  align-items:center;
  gap:.5rem;
  padding:.25rem .75rem;
  border-radius:1rem;
  font-size:.75rem;
  font-weight:600;
  color:#f43f5e;
  background:rgba(244,63,94,.15);
  text-transform:none;
  letter-spacing:.01em;
}
html.dark .rc-hero-badge{
  color:#fff;
  background:rgba(244,63,94,.25);
}
.rc-hero-title{
  margin:0;
  font-size:clamp(2.75rem,5vw,4rem);
  font-weight:800;
  line-height:1.1;
  color:rgb(30 41 59);
}
html.dark .rc-hero-title{color:#fff}
.rc-hero-subtitle{
  margin:0;
  font-size:1.125rem;
  max-width:40rem;
  color:rgb(100 116 139);
}
html.dark .rc-hero-subtitle{color:rgb(203 213 225)}
.rc-hero-actions{
  display:flex;
  flex-wrap:wrap;
  gap:1rem;
  justify-content:center;
  margin-top:.5rem;
}

/* Hero-specific button variants -------------------------------- */
.rc-btn-primary{
  --pad-y:.875rem;--pad-x:2rem;
  color:#fff;
  background:#f43f5e;
  border-color:#f43f5e;
  box-shadow:0 2px 8px rgba(244,63,94,.45);
}
.rc-btn-primary:hover,
.rc-btn-primary:focus-visible{
  background:#e11d48;
  border-color:#e11d48;
  box-shadow:0 4px 16px rgba(244,63,94,.65);
  outline:none;
}
.rc-btn-outline{
  --pad-y:.875rem;--pad-x:2rem;
  color:#f43f5e;
  background:transparent;
  border-color:#f43f5e;
}
.rc-btn-outline:hover,
.rc-btn-outline:focus-visible{
  background:rgba(244,63,94,.1);
  outline:none;
}
.rc-btn-text{
  --pad-y:.25rem;--pad-x:.5rem;
  color:#2563eb;
  background:transparent;
  border:none;
  font-weight:600;
  font-size:.9375rem;
  padding-inline:.5rem;
}
.rc-btn-text:hover,
.rc-btn-text:focus-visible{
  text-decoration:underline;
  transform:none;
  outline:none;
}
html.dark .rc-btn-outline{
  color:#fff;
  border-color:#fff;
}
html.dark .rc-btn-outline:hover{background:rgba(255,255,255,.1)}
html.dark .rc-btn-text{color:#93c5fd}
/* ---------- Shared section head ---------- */
.rc-section-head{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:2rem}
.rc-section-head-split{align-items:flex-start}
.rc-section-title{margin:0;font-size:1.25rem;font-weight:700;color:rgb(30 41 59)}
html.dark .rc-section-title{color:rgb(241 245 249)}
.rc-section-title-sub{margin-bottom:1rem}
.rc-section-ico{font-size:1.25em;line-height:1}
.rc-section-sub{font-size:.8125rem;color:rgb(100 116 139);display:flex;align-items:center;gap:.25rem;flex-wrap:wrap}
html.dark .rc-section-sub{color:rgb(148 163 184)}
.rc-mini-btn{padding:0 .5rem;height:1.25rem;font-size:.75rem;line-height:1;border-radius:.25rem;border:1px solid var(--rc-border-light,rgba(0,0,0,.2));background:transparent;color:inherit;cursor:pointer}
html.dark .rc-mini-btn{border-color:var(--rc-border-dark,rgba(255,255,255,.25))}

/* ---------- Metrics grid ---------- */
.rc-metrics{padding-block:2.5rem}
.rc-metrics-grid{display:grid;gap:1.25rem;grid-template-columns:repeat(auto-fit,minmax(min(16rem,100%),1fr));align-items:stretch}
.rc-metric-body{position:relative;padding:1.25rem;display:grid;gap:.75rem}
.rc-metric-top{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem}
.rc-metric-label{margin:0;font-size:.875rem;font-weight:600;color:rgb(100 116 139)}
html.dark .rc-metric-label{color:rgb(148 163 184)}
.rc-metric-value{margin:0;font-size:2.25rem;font-weight:700;line-height:1;color:rgb(30 41 59)}
html.dark .rc-metric-value{color:rgb(241 245 249)}
.rc-metric-trend{margin:0;font-size:.75rem;font-weight:600}
.rc-metric-up{color:rgb(16 185 129)}
.rc-metric-down{color:rgb(244 63 94)}
.rc-metric-trend-empty{color:transparent;user-select:none}
.rc-metric-icon{line-height:0}
.rc-ico{width:1.25rem;height:1.25rem}
.rc-card-link{position:relative}
.rc-card-link>a:focus-visible{outline:2px solid var(--rc-accent,#f43f5e);outline-offset:2px}

/* Accent swatches (lightweight) */
.rc-accent-primary{--rc-card-border:color-mix(in srgb,#f43f5e 35%,transparent)}
.rc-accent-amber{--rc-card-border:color-mix(in srgb,#fbbf24 35%,transparent)}
.rc-accent-rose{--rc-card-border:color-mix(in srgb,#fb7185 35%,transparent)}
.rc-accent-indigo{--rc-card-border:color-mix(in srgb,#818cf8 35%,transparent)}
.rc-metric{border:1px solid var(--rc-card-border,rgba(0,0,0,.08));border-radius:1rem;background:var(--rc-surface-1-light,#fff);box-shadow:0 1px 2px rgba(0,0,0,.04)}
html.dark .rc-metric{background:rgb(30 41 59/.85);border-color:var(--rc-card-border,rgba(255,255,255,.08))}

/* ---------- Trend + Activity grid ---------- */
.rc-trend-activity{padding-block:2.5rem}
.rc-trend-activity-grid{display:grid;gap:2rem;grid-template-columns:1fr;align-items:start}
@media (min-width:1024px){.rc-trend-activity-grid{grid-template-columns:2fr 1fr}}
.rc-trend-col{padding:1.5rem;display:grid;gap:1.5rem}
.rc-chart-wrap{position:relative;width:100%;height:280px}
.rc-chart-wrap canvas{width:100%!important;height:280px!important}
.rc-chart-foot{display:flex;justify-content:flex-end;gap:1rem;font-size:.8125rem}
.rc-chart-foot-btn{padding:.25rem .75rem;border-radius:.5rem;border:1px solid var(--rc-border-light,rgba(0,0,0,.15));background:transparent;cursor:pointer}
html.dark .rc-chart-foot-btn{border-color:var(--rc-border-dark,rgba(255,255,255,.15))}
.rc-activity-col{padding:1.5rem;display:grid;gap:1.5rem;max-height:100%}
.rc-activity-list{max-height:20rem;overflow-y:auto;padding-right:.25rem;margin-right:-.25rem;display:grid;gap:.75rem}
.rc-activity-item{display:flex;gap:.75rem;padding:.75rem;border-radius:.75rem;transition:background .12s ease,box-shadow .12s ease}
.rc-activity-item:hover,.rc-activity-item:focus-within{background:rgba(0,0,0,.04);box-shadow:0 1px 3px rgba(0,0,0,.08)}
html.dark .rc-activity-item:hover,html.dark .rc-activity-item:focus-within{background:rgba(255,255,255,.08)}
.rc-activity-ico{font-size:1.25rem;line-height:1}
.rc-activity-body{flex:1;min-width:0}
.rc-activity-text{margin:0;font-size:.875rem;font-weight:600;color:rgb(30 41 59);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
html.dark .rc-activity-text{color:rgb(241 245 249)}
.rc-activity-link{text-decoration:underline;color:var(--rc-accent,#f43f5e)}
.rc-activity-link:hover{text-decoration:none}
.rc-activity-meta{margin:0;margin-top:.25rem;font-size:.75rem;color:rgb(100 116 139);display:flex;align-items:center;gap:.25rem}
html.dark .rc-activity-meta{color:rgb(148 163 184)}
.rc-activity-dot{opacity:.5}
.rc-activity-empty{margin:0;font-size:.875rem;color:rgb(148 163 184);text-align:center;padding:2rem 0}
.rc-activity-more{text-align:center;font-size:.875rem;margin-top:.5rem}
.rc-activity-more-link{text-decoration:none;color:var(--rc-accent,#f43f5e)}
.rc-activity-more-link:hover{text-decoration:underline}

/* ---------- Quick Actions ---------- */
.rc-quick-actions{padding-block:3.5rem}
.rc-quick-actions{padding-block-end:1.25rem}
.rc-qa-grid{display:grid;gap:1.25rem;grid-template-columns:repeat(auto-fit,minmax(min(16rem,100%),1fr))}
.rc-qa-card{position:relative;padding:1.5rem;border-radius:1rem;text-decoration:none;transition:transform .15s ease,box-shadow .15s ease;cursor:pointer}
.rc-qa-card:hover,.rc-qa-card:focus-visible{transform:translateY(-4px);box-shadow:0 10px 24px -8px rgba(0,0,0,.3);outline:none}
.rc-qa-card-inner{display:flex;align-items:center;gap:1rem;font-weight:600;font-size:1.0625rem;width:100%}
.rc-qa-ico{font-size:1.5rem;line-height:1}
.rc-qa-textwrap{display:grid;gap:.25rem;text-align:left}
.rc-qa-text{font-weight:700;font-size:1.0625rem;color:rgb(30 41 59)}
html.dark .rc-qa-text{color:rgb(241 245 249)}
.rc-qa-desc{font-size:.875rem;font-weight:400;color:rgb(100 116 139)}
html.dark .rc-qa-desc{color:rgb(148 163 184)}
.rc-qa-arrow{margin-left:auto;opacity:.5;transition:opacity .12s ease}
.rc-qa-card:hover .rc-qa-arrow,.rc-qa-card:focus-visible .rc-qa-arrow{opacity:1}
.rc-qa-import{--qa-base:#8b5cf6;background:color-mix(in srgb,var(--qa-base) 10%,#fff);border:1px solid color-mix(in srgb,var(--qa-base) 35%,transparent)}
.rc-qa-diagram{--qa-base:#fbbf24;background:color-mix(in srgb,var(--qa-base) 10%,#fff);border:1px solid color-mix(in srgb,var(--qa-base) 35%,transparent)}
.rc-qa-docs{--qa-base:#38bdf8;background:color-mix(in srgb,var(--qa-base) 10%,#fff);border:1px solid color-mix(in srgb,var(--qa-base) 35%,transparent)}
html.dark .rc-qa-import{background:color-mix(in srgb,var(--qa-base) 15%,rgb(30 41 59 / .85))}
html.dark .rc-qa-diagram{background:color-mix(in srgb,var(--qa-base) 15%,rgb(30 41 59 / .85))}
html.dark .rc-qa-docs{background:color-mix(in srgb,var(--qa-base) 15%,rgb(30 41 59 / .85))}

/* ---------- Generic RC button fallback ---------- */
.rc-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
  font-size:.9375rem;
  line-height:1;
  text-decoration:none;
  padding:var(--pad-y,.625rem) var(--pad-x,1.25rem);
  border-radius:9999px;
  transition:background .12s ease,border-color .12s ease,transform .12s ease;
  cursor:pointer;
  border:2px solid transparent;
}
.rc-btn:focus-visible{outline:2px solid currentColor;outline-offset:2px}
.rc-btn:hover{transform:translateY(-1px)}

/* ---------- CTA Button Variants for Onboard gradient ---------- */
.rc-btn-light{
  --pad-y:.875rem;--pad-x:2rem;
  color:#f43f5e;
  background:#fff;
  border-color:#fff;
  box-shadow:0 2px 8px rgba(255,255,255,.35),0 0 0 4px rgba(255,255,255,.25) inset;
}
.rc-btn-light:hover,
.rc-btn-light:focus-visible{
  color:#fff;
  background:#f43f5e;
  border-color:#fff;
  box-shadow:0 4px 16px rgba(255,255,255,.45);
  outline:none;
}

.rc-btn-ghost{
  --pad-y:.875rem;--pad-x:2rem;
  color:#fff;
  background:rgba(255,255,255,.08);
  border-color:rgba(255,255,255,.6);
  box-shadow:0 0 0 2px rgba(255,255,255,.25) inset;
}
.rc-btn-ghost:hover,
.rc-btn-ghost:focus-visible{
  background:rgba(255,255,255,.18);
  border-color:#fff;
  box-shadow:0 0 0 2px #fff inset;
  outline:none;
}

/* ---------- Onboard Callout ---------- */
.rc-onboard-callout{margin-top:4rem;position:relative;overflow:hidden;text-align:center;padding:1.75rem 1.5rem;border-radius:1.5rem;color:#fff;
background:linear-gradient(135deg,#f43f5e 0%,#fb7185 100%);text-shadow:0 1px 2px rgba(0,0,0,.4)}
html.dark .rc-onboard-callout{background:linear-gradient(135deg,#f43f5e 0%,#e11d48 100%)}
.rc-onboard-inner{position:relative;z-index:1;display:grid;gap:1rem;justify-items:center;max-width:32rem;margin-inline:auto}
.rc-onboard-title{margin:0;font-size:1.5rem;font-weight:700}
.rc-onboard-desc{margin:0;font-size:1rem;opacity:.9;max-width:28rem}
.rc-onboard-actions{display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;margin-top:.5rem}

@media (max-width:480px){
  .rc-onboard-actions .rc-btn{width:100%;max-width:100%}
}
.rc-onboard-btn{--pad-y:.75rem;--pad-x:1.5rem}

/* ---------- Layout wrapper fallback (prevents ultra-wide stretch) ---------- */
.wrapper{max-width:min(90rem,100%);margin-inline:auto;padding-inline:clamp(1rem,3vw,2rem)}

/* ---------- Hero overrides specific to dashboard ---------- */
/* (reserved for per-page hero tweaks) */

/* ---------- Layout Polish Overrides (cascade) ---------- */
/* Global section rhythm */
.rc-section{margin-block:clamp(3rem,6vh,4.5rem)}

/* Tighter section headings (override earlier 2rem) */
.rc-section-head{margin-bottom:1.5rem}

/* Extra air between hero + metrics */
.rc-metrics{margin-top:clamp(2.5rem,5vh,4rem)}

/* Uniform metric card heights + fluid number sizing */
.rc-metric-body{min-block-size:8.5rem}
@media (min-width:640px){
  .rc-metric-body{min-block-size:7.5rem}
}
.rc-metric-value{font-size:clamp(1.75rem,3vw,2.25rem)}

/* Allow activity text to wrap (fix ellipsis truncation) */
.rc-activity-text{white-space:normal;overflow-wrap:anywhere}

/* Taller activity region on larger screens */
@media (min-width:1024px){
  .rc-activity-list{max-height:24rem}
}

/* Larger tap targets for hero buttons */
.rc-hero-actions .rc-btn{min-height:44px}

/* Slightly taller mini-btn */
.rc-mini-btn{min-height:24px}

/* Quick Actions sizing refinements */
.rc-qa-card{padding-block:2rem}
@media (min-width:640px){
  .rc-qa-grid{grid-template-columns:repeat(auto-fit,minmax(18rem,1fr))}
}
</style>
{% endblock styles %}



{# ============================================================
   PAGE SCRIPTS
   ============================================================ #}
{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js" defer></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ----- Metrics Refresh ---------------------------------- */
    const refreshBtn = document.getElementById('rc-metrics-refresh');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        fetch('{{ url_for("main.index") }}?format=json', {headers:{'Accept':'application/json'}})
          .then(r => r.ok ? r.json() : Promise.reject(r))
          .then(data => {
            if (!data.stats) return;
            const map = {
              'Total Rules': data.stats.total_rules ?? 0,
              'Changed ¬∑ 7 Days': data.stats.changed_7d ?? 0,
              'Changed ¬∑ 30 Days': data.stats.changed_30d ?? 0,
              'Changed ¬∑ 90 Days': data.stats.changed_90d ?? 0
            };
            document.querySelectorAll('.rc-metric').forEach(card => {
              const label = card.querySelector('.rc-metric-label')?.textContent?.trim();
              if (label in map) {
                const el = card.querySelector('.rc-metric-value');
                if (el) el.textContent = map[label];
              }
            });
          })
          .catch(() => {/* ignore */});
      });
    }

    /* ----- Trend Chart ------------------------------------- */
    const ctx = document.getElementById('rulesTrendChart');
    if (ctx && window.Chart) {
      const trendData = {{ (trend_data if (trend_data is defined and trend_data is not none) else [])|tojson }};
      const {labels,counts} = (()=>{
        const L = [], C = [];
        (trendData||[]).forEach(d=>{
          L.push(d.label || d.date || '');
          C.push(d.count ?? d.value ?? 0);
        });
        return {labels:L,counts:C};
      })();

      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Rule Changes',
            data: counts,
            borderColor: '#f43f5e',
            backgroundColor: 'rgba(244,63,94,.15)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#f43f5e',
            pointBorderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: '#6b7280' } },
            y: { grid: { color: 'rgba(229,231,235,.3)' }, ticks: { color: '#6b7280' }, beginAtZero: true }
          }
        }
      });

      document.querySelectorAll('.rc-toggle-pill .rc-toggle').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.rc-toggle-pill .rc-toggle').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const range=btn.dataset.range;
          // TODO: fetch new dataset for selected range; update chart.data then chart.update()
          chart.update();
        });
      });
    }

  });
  </script>
{% endblock scripts %}