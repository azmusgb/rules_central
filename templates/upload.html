{% extends 'layouts/base.html' %}
{% from 'macros/components.html' import button, alert %}
{% block title %}Upload Diagram{% endblock %}
{% block content %}
<h1 class="sr-only">Upload</h1>
<form id="upload-form" action="{{ url_for('upload_file') if 'upload_file' in globals() else url_for('routes_bp.upload_file') }}" method="post"
      enctype="multipart/form-data" class="max-w-xl mx-auto space-y-4">
  {{ csrf_field() }}
  <div class="border-2 border-dashed border-slate-600 p-8 text-center rounded"
       x-data="{hover:false}" @dragover.prevent="hover=true" @dragleave="hover=false" @drop.prevent>
    <p class="mb-2">Drag files here or click to select</p>
    <input type="file" name="file" class="hidden" x-ref="file">
    <button type="button" @click="$refs.file.click()" class="underline">Choose File</button>
  </div>
  {% if error %}
    {{ alert(error, 'error') }}
  {% endif %}
  {{ button('Upload', 'primary', 'submit') }}
  <div id="progress" class="h-2 bg-slate-700 rounded hidden">
    <div class="h-full bg-primary-600 w-0" id="progress-bar"></div>
  </div>
</form>
{% endblock %}
{% block scripts %}
<script>
const form=document.getElementById('upload-form');
const bar=document.getElementById('progress-bar');
form.addEventListener('submit',e=>{
  e.preventDefault();
  const xhr=new XMLHttpRequest();
  xhr.open('POST',form.action);
  xhr.upload.onprogress=ev=>{
    document.getElementById('progress').classList.remove('hidden');
    bar.style.width=(ev.loaded/ev.total*100)+'%';
  };
  xhr.onload=()=>location.reload();
  xhr.send(new FormData(form));
});
</script>
{% endblock %}
